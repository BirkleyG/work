<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lead Drop</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg: #060d1a;
      --bg2: #091225;
      --card: #0d1929;
      --border: #1a2e50;
      --text: #e8eeff;
      --muted: #5a7aa8;
      --orange: #ff7a1a;
      --orange2: #ff5500;
      --orange-glow: rgba(255,122,26,0.25);
      --orange-light: #ffab5e;
      --blue: #1a3a6e;
      --blue-light: #2a5aaa;
      --gold: #ffc046;
    }
    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Starfield background */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 80% 60% at 50% -10%, #0d2250 0%, transparent 65%),
        radial-gradient(ellipse 40% 40% at 80% 80%, #1a1000 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }

    .page {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 28px 20px 40px;
    }

    /* HEADER */
    .header {
      text-align: center;
      margin-bottom: 8px;
    }
    .header h1 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(42px, 8vw, 72px);
      letter-spacing: 4px;
      margin: 0;
      background: linear-gradient(160deg, #fff 20%, var(--orange-light) 60%, var(--orange) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1;
      filter: drop-shadow(0 0 24px var(--orange-glow));
    }
    .header .sub {
      font-size: 13px;
      color: var(--muted);
      letter-spacing: 3px;
      text-transform: uppercase;
      margin-top: 4px;
    }

    /* GOAL TICKER */
    .goal-bar {
      margin-top: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      color: var(--muted);
    }
    .goal-bar .count {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 32px;
      color: var(--orange);
      line-height: 1;
      letter-spacing: 1px;
    }
    .goal-bar .slash { color: var(--border); font-size: 24px; }
    .goal-bar .goal-num {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 22px;
      color: var(--muted);
      letter-spacing: 1px;
    }

    /* GLASS STAGE */
    .glass-section {
      margin-top: 16px;
      position: relative;
      display: flex;
      justify-content: center;
    }
    .glass-stage {
      width: 200px;
      height: 290px;
      position: relative;
    }
    .glass-outer {
      position: absolute;
      inset: 0;
      border-radius: 28px 28px 40px 40px;
      border: 2px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
      overflow: hidden;
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.04),
        0 20px 60px rgba(0,0,0,0.6),
        inset 0 0 30px rgba(255,255,255,0.02);
    }
    /* shine */
    .glass-outer::before {
      content: "";
      position: absolute;
      top: 16px; left: 18px;
      width: 14px; height: 65%;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      filter: blur(1px);
    }
    .water {
      position: absolute;
      left: 0; right: 0; bottom: 0;
      height: 0%;
      background: linear-gradient(180deg,
        rgba(255,140,40,0.95) 0%,
        rgba(255,80,0,0.85) 50%,
        rgba(200,50,0,0.9) 100%
      );
      transition: height 900ms cubic-bezier(0.2, 0.9, 0.2, 1);
    }
    .water::after {
      content: "";
      position: absolute;
      left: -20%; right: -20%; top: -12px;
      height: 24px;
      background: rgba(255,180,80,0.3);
      border-radius: 999px;
      filter: blur(3px);
    }
    /* Liquid glow */
    .water-glow {
      position: absolute;
      left: 0; right: 0; bottom: 0;
      height: 0%;
      background: transparent;
      box-shadow: 0 0 40px 20px rgba(255,100,0,0.2);
      transition: height 900ms cubic-bezier(0.2, 0.9, 0.2, 1);
      pointer-events: none;
      border-radius: 0 0 40px 40px;
    }
    .goal-line {
      position: absolute;
      left: 8px; right: 8px;
      border-top: 2px dashed rgba(255,255,255,0.18);
      pointer-events: none;
    }

    /* Droplet */
    .droplet {
      position: absolute;
      left: 50%;
      top: -50px;
      width: 20px; height: 26px;
      transform: translateX(-50%);
      opacity: 0;
      pointer-events: none;
    }
    .droplet svg { width: 100%; height: 100%; }
    .drop-anim { animation: drop 560ms cubic-bezier(0.2,0.8,0.2,1) forwards; }
    @keyframes drop {
      0%   { transform: translate(-50%,0) scale(0.85); opacity: 0; }
      12%  { opacity: 1; }
      100% { transform: translate(-50%,295px) scale(1); opacity: 1; }
    }
    .ripple {
      position: absolute;
      left: 50%; top: 295px;
      width: 20px; height: 10px;
      transform: translateX(-50%);
      border-radius: 999px;
      border: 1.5px solid rgba(255,160,60,0.5);
      opacity: 0;
      pointer-events: none;
    }
    .ripple-anim { animation: ripple-out 440ms ease-out forwards; }
    @keyframes ripple-out {
      0%   { opacity: 0.8; transform: translateX(-50%) scale(0.5); }
      100% { opacity: 0; transform: translateX(-50%) scale(3); }
    }

    /* Percentage label on glass */
    .pct-label {
      position: absolute;
      bottom: 10px;
      width: 100%;
      text-align: center;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 28px;
      letter-spacing: 1px;
      color: rgba(255,255,255,0.9);
      text-shadow: 0 2px 8px rgba(0,0,0,0.6);
      pointer-events: none;
      z-index: 2;
    }

    /* BUTTONS */
    .btn-grid {
      margin-top: 28px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      width: min(420px, 100%);
    }
    .user-btn {
      position: relative;
      overflow: hidden;
      padding: 16px 12px;
      border-radius: 16px;
      border: 1.5px solid var(--border);
      background: linear-gradient(160deg, #0e1e38, #091428);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 80ms, border-color 200ms, box-shadow 200ms;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
    }
    .user-btn .plus {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 26px;
      line-height: 1;
      color: var(--orange);
    }
    .user-btn .name { font-size: 13px; letter-spacing: 1px; color: var(--muted); }
    .user-btn .today { font-size: 20px; font-weight: 800; color: #fff; }

    .user-btn:hover {
      border-color: var(--orange);
      box-shadow: 0 0 20px var(--orange-glow), inset 0 0 20px rgba(255,122,26,0.04);
      transform: translateY(-1px);
    }
    .user-btn:active { transform: scale(0.97); }
    .user-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .user-btn .ripple-circle {
      position: absolute;
      border-radius: 50%;
      background: rgba(255,122,26,0.3);
      transform: scale(0);
      animation: btn-ripple 500ms ease-out;
      pointer-events: none;
    }
    @keyframes btn-ripple {
      to { transform: scale(4); opacity: 0; }
    }

    /* FLASH overlay per button */
    .user-btn::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, rgba(255,122,26,0.2), transparent 70%);
      opacity: 0;
      transition: opacity 0.15s;
      border-radius: 16px;
    }
    .user-btn.flash::after { opacity: 1; }

    /* STATS BUTTON */
    .stats-btn-wrap {
      margin-top: 28px;
    }
    .stats-btn {
      padding: 14px 40px;
      border-radius: 999px;
      border: 1.5px solid var(--border);
      background: linear-gradient(160deg, #0e1e38, #091428);
      color: var(--muted);
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 200ms;
    }
    .stats-btn:hover {
      border-color: var(--orange);
      color: var(--orange-light);
      box-shadow: 0 0 20px var(--orange-glow);
    }

    /* TOAST */
    .toast {
      position: fixed; top: 16px; left: 50%;
      transform: translateX(-50%);
      background: #0e1929;
      border: 1px solid var(--orange);
      padding: 10px 18px;
      border-radius: 12px;
      font-size: 13px;
      color: var(--orange-light);
      box-shadow: 0 0 20px var(--orange-glow);
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
      z-index: 9999;
      white-space: nowrap;
    }
    .toast.show { opacity: 1; }

    /* MODAL */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(4,9,20,0.85);
      backdrop-filter: blur(6px);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 1000;
      padding: 0;
    }
    .modal-backdrop.open { display: flex; }
    .modal {
      width: min(780px, 100%);
      max-height: 88vh;
      background: linear-gradient(180deg, #0e1a2e, #091220);
      border: 1px solid var(--border);
      border-radius: 24px 24px 0 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 -20px 60px rgba(0,0,0,0.7);
      animation: slide-up 300ms cubic-bezier(0.2,0.9,0.2,1);
    }
    @keyframes slide-up {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    .modal-handle {
      width: 40px; height: 4px;
      background: var(--border);
      border-radius: 999px;
      margin: 12px auto 0;
      flex-shrink: 0;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px 0;
      flex-shrink: 0;
    }
    .modal-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 26px;
      letter-spacing: 2px;
      color: var(--text);
    }
    .close-btn {
      width: 32px; height: 32px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      font-size: 18px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 150ms;
      line-height: 1;
    }
    .close-btn:hover { border-color: var(--orange); color: var(--orange); }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      padding: 12px 20px 0;
      overflow-x: auto;
      flex-shrink: 0;
      scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar { display: none; }
    .tab {
      padding: 8px 16px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 150ms;
    }
    .tab:hover { color: var(--text); }
    .tab.active {
      background: #0e1e38;
      border-color: var(--border);
      color: var(--orange-light);
    }

    /* Tab content */
    .tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px 24px;
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* Stat cards */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 10px;
      margin-bottom: 18px;
    }
    .stat-card {
      background: #0a1626;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 12px;
    }
    .stat-card .s-label { font-size: 11px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }
    .stat-card .s-val {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 32px;
      color: var(--orange-light);
      letter-spacing: 1px;
      line-height: 1.1;
      margin-top: 4px;
    }

    /* Leaderboard table */
    .lb-table { width: 100%; border-collapse: collapse; }
    .lb-table th {
      text-align: left;
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 1.5px;
      text-transform: uppercase;
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
    }
    .lb-table td {
      padding: 11px 10px;
      font-size: 14px;
      border-bottom: 1px solid rgba(26,46,80,0.5);
    }
    .lb-table tr:last-child td { border-bottom: none; }
    .lb-table .rank {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 20px;
      color: var(--muted);
      width: 36px;
    }
    .lb-table tr:nth-child(1) .rank { color: var(--gold); }
    .lb-table tr:nth-child(2) .rank { color: #c0c0c0; }
    .lb-table tr:nth-child(3) .rank { color: #cd7f32; }
    .lb-table .count-cell {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 22px;
      color: var(--orange);
      text-align: right;
    }

    /* Mini bar chart */
    .bar-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .bar-label { font-size: 13px; color: var(--muted); width: 80px; flex-shrink: 0; }
    .bar-track {
      flex: 1;
      height: 22px;
      background: #0a1626;
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--orange2), var(--orange));
      border-radius: 6px;
      transition: width 600ms cubic-bezier(0.2,0.9,0.2,1);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
      font-size: 11px;
      font-weight: 700;
      color: rgba(255,255,255,0.9);
      min-width: 2px;
    }

    /* Section label */
    .section-label {
      font-size: 11px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      margin: 14px 0 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border);
    }

    /* Feed */
    .feed-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 9px 0;
      border-bottom: 1px solid rgba(26,46,80,0.4);
      font-size: 13px;
    }
    .feed-item:last-child { border-bottom: none; }
    .feed-item .fi-name { color: var(--text); font-weight: 600; }
    .feed-item .fi-co { color: var(--muted); }
    .feed-item .fi-time { font-size: 11px; color: var(--muted); }

    .empty { color: var(--muted); font-size: 13px; padding: 12px 0; }

    /* Scrollbar */
    .tab-content::-webkit-scrollbar { width: 4px; }
    .tab-content::-webkit-scrollbar-track { background: transparent; }
    .tab-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 999px; }

    @media (max-width: 480px) {
      .btn-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
      .user-btn { padding: 14px 10px; }
    }
  </style>
</head>

<body>
<div class="toast" id="toast"></div>

<div class="page">
  <div class="header">
    <h1>Lead Drop</h1>
    <div class="sub">Every lead fills the glass</div>
  </div>

  <div class="goal-bar">
    <div>
      <span class="count" id="totalCount">0</span>
      <span class="slash"> /</span>
      <span class="goal-num" id="goalNum">100</span>
    </div>
    <div style="color:var(--muted);font-size:12px">ALL-TIME LEADS</div>
  </div>

  <!-- Glass -->
  <div class="glass-section">
    <div class="glass-stage">
      <div class="glass-outer">
        <div class="water" id="water"></div>
        <div class="water-glow" id="waterGlow"></div>
        <div class="goal-line" id="goalLine" style="top:6%"></div>
      </div>
      <div class="pct-label" id="pctLabel">0%</div>
      <div class="droplet" id="droplet">
        <svg viewBox="0 0 20 26" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M10 0C14.5 8 20 13 20 18C20 22.4 15.5 26 10 26C4.5 26 0 22.4 0 18C0 13 5.5 8 10 0Z"
                fill="url(#dg)"/>
          <defs>
            <linearGradient id="dg" x1="10" y1="0" x2="10" y2="26" gradientUnits="userSpaceOnUse">
              <stop offset="0%" stop-color="#ffcc80"/>
              <stop offset="100%" stop-color="#ff6000"/>
            </linearGradient>
          </defs>
        </svg>
      </div>
      <div class="ripple" id="ripple"></div>
    </div>
  </div>

  <!-- Per-user buttons -->
  <div class="btn-grid">
    <button class="user-btn" id="btn-Alston" data-user="Alston" disabled>
      <span class="plus">+1</span>
      <span class="today" id="today-Alston">0</span>
      <span class="name">ALSTON</span>
    </button>
    <button class="user-btn" id="btn-Jennifer" data-user="Jennifer" disabled>
      <span class="plus">+1</span>
      <span class="today" id="today-Jennifer">0</span>
      <span class="name">JENNIFER</span>
    </button>
    <button class="user-btn" id="btn-Lina" data-user="Lina" disabled>
      <span class="plus">+1</span>
      <span class="today" id="today-Lina">0</span>
      <span class="name">LINA</span>
    </button>
    <button class="user-btn" id="btn-Ziyu" data-user="Ziyu" disabled>
      <span class="plus">+1</span>
      <span class="today" id="today-Ziyu">0</span>
      <span class="name">ZIYU</span>
    </button>
  </div>

  <div class="stats-btn-wrap">
    <button class="stats-btn" id="statsBtn">ðŸ“Š View Stats</button>
  </div>
</div>

<!-- STATS MODAL -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title">Performance Stats</div>
      <button class="close-btn" id="closeModal">âœ•</button>
    </div>
    <div class="tabs" id="tabBar">
      <button class="tab active" data-tab="leaderboard">Leaderboard</button>
      <button class="tab" data-tab="trends">Trends</button>
      <button class="tab" data-tab="Alston">Alston</button>
      <button class="tab" data-tab="Jennifer">Jennifer</button>
      <button class="tab" data-tab="Lina">Lina</button>
      <button class="tab" data-tab="Ziyu">Ziyu</button>
    </div>
    <div class="tab-content">

      <!-- Leaderboard -->
      <div class="tab-panel active" id="panel-leaderboard">
        <div class="section-label">Today</div>
        <table class="lb-table"><thead><tr>
          <th class="rank">#</th><th>Name</th><th style="text-align:right">Leads</th>
        </tr></thead><tbody id="lb-today"></tbody></table>

        <div class="section-label" style="margin-top:20px">All-Time</div>
        <table class="lb-table"><thead><tr>
          <th class="rank">#</th><th>Name</th><th style="text-align:right">Leads</th>
        </tr></thead><tbody id="lb-all"></tbody></table>
      </div>

      <!-- Trends -->
      <div class="tab-panel" id="panel-trends">
        <div class="stat-grid">
          <div class="stat-card"><div class="s-label">Total All-Time</div><div class="s-val" id="st-total">â€”</div></div>
          <div class="stat-card"><div class="s-label">Today (Team)</div><div class="s-val" id="st-today">â€”</div></div>
          <div class="stat-card"><div class="s-label">7-Day Avg</div><div class="s-val" id="st-avg">â€”</div></div>
          <div class="stat-card"><div class="s-label">Best Day</div><div class="s-val" id="st-best">â€”</div></div>
        </div>

        <div class="section-label">Last 7 Days by Person</div>
        <div id="trends-bars"></div>

        <div class="section-label" style="margin-top:20px">Recent Activity</div>
        <div id="recent-feed"></div>
      </div>

      <!-- Per-user panels -->
      <div class="tab-panel" id="panel-Alston"><div id="user-panel-Alston"></div></div>
      <div class="tab-panel" id="panel-Jennifer"><div id="user-panel-Jennifer"></div></div>
      <div class="tab-panel" id="panel-Lina"><div id="user-panel-Lina"></div></div>
      <div class="tab-panel" id="panel-Ziyu"><div id="user-panel-Ziyu"></div></div>

    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, doc, getDoc, setDoc, addDoc,
    query, orderBy, limit, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getAuth, signInAnonymously, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  // â”€â”€ Firebase config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const firebaseConfig = {
    apiKey: "AIzaSyD_lk0-JE861RqFt9dZR1YMRl-qr_9xHtU",
    authDomain: "lead-tracker-c13ca.firebaseapp.com",
    projectId: "lead-tracker-c13ca",
    storageBucket: "lead-tracker-c13ca.firebasestorage.app",
    messagingSenderId: "590497117694",
    appId: "1:590497117694:web:dc071c3b8506273667fcaf",
    measurementId: "G-Q3NW44KW1K"
  };

  const TEAM = ["Alston","Jennifer","Lina","Ziyu"];
  const GOAL = 100;

  const app  = initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);

  // â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const waterEl     = document.getElementById("water");
  const waterGlow   = document.getElementById("waterGlow");
  const dropletEl   = document.getElementById("droplet");
  const rippleEl    = document.getElementById("ripple");
  const pctLabel    = document.getElementById("pctLabel");
  const totalCount  = document.getElementById("totalCount");
  const goalNumEl   = document.getElementById("goalNum");
  const toastEl     = document.getElementById("toast");
  const statsBtn    = document.getElementById("statsBtn");
  const modalBd     = document.getElementById("modalBackdrop");
  const closeModal  = document.getElementById("closeModal");
  const tabBar      = document.getElementById("tabBar");

  goalNumEl.textContent = GOAL;

  // â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(() => toastEl.classList.remove("show"), 2400);
  }

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startOfToday() {
    const d = new Date(); d.setHours(0,0,0,0); return d;
  }
  function startOf7DaysAgo() {
    return new Date(Date.now() - 7 * 86400000);
  }
  function fmtTime(date) {
    const now = new Date();
    const diff = (now - date) / 1000;
    if (diff < 60) return "just now";
    if (diff < 3600) return Math.floor(diff/60) + "m ago";
    if (diff < 86400) return Math.floor(diff/3600) + "h ago";
    return date.toLocaleDateString("en-US",{month:"short",day:"numeric"});
  }

  // â”€â”€ Droplet animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function playDroplet() {
    dropletEl.classList.remove("drop-anim");
    rippleEl.classList.remove("ripple-anim");
    void dropletEl.offsetWidth;
    dropletEl.classList.add("drop-anim");
    setTimeout(() => {
      rippleEl.classList.add("ripple-anim");
      setTimeout(() => rippleEl.classList.remove("ripple-anim"), 450);
    }, 480);
    setTimeout(() => dropletEl.classList.remove("drop-anim"), 600);
  }

  function btnRipple(btn) {
    const r = document.createElement("span");
    r.className = "ripple-circle";
    const sz = Math.max(btn.offsetWidth, btn.offsetHeight);
    r.style.cssText = `width:${sz}px;height:${sz}px;left:${btn.offsetWidth/2 - sz/2}px;top:${btn.offsetHeight/2 - sz/2}px`;
    btn.appendChild(r);
    r.addEventListener("animationend", () => r.remove());

    btn.classList.add("flash");
    setTimeout(() => btn.classList.remove("flash"), 200);
  }

  // â”€â”€ Water fill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setFill(total) {
    const pct = Math.min(100, (total / GOAL) * 100);
    const h = pct.toFixed(1) + "%";
    waterEl.style.height = h;
    waterGlow.style.height = h;
    pctLabel.textContent = Math.round(pct) + "%";
    totalCount.textContent = total;
  }

  // â”€â”€ Anonymous auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let uid = null;
  let listenersStarted = false;
  let allLeads = [];

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      uid = user.uid;
      enableButtons();
      if (!listenersStarted) { listenersStarted = true; initLeadsListener(); }
    } else {
      try { await signInAnonymously(auth); }
      catch(e) { toast("Auth error â€” check Firebase Anonymous Auth."); console.error(e); }
    }
  });

  function enableButtons() {
    TEAM.forEach(n => {
      const b = document.getElementById("btn-" + n);
      if (b) b.disabled = false;
    });
  }

  // â”€â”€ Lead buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  TEAM.forEach(name => {
    const btn = document.getElementById("btn-" + name);
    if (!btn) return;
    btn.addEventListener("click", async () => {
      if (!uid) return toast("Not signed in yetâ€¦");
      btn.disabled = true;
      playDroplet();
      btnRipple(btn);
      try {
        await addDoc(collection(db,"leads"), {
          createdAt: serverTimestamp(),
          userName: name,
          companyId: "",
          companyName: ""
        });
      } catch(e) {
        toast("Could not save lead."); console.error(e);
      } finally {
        setTimeout(() => { btn.disabled = false; }, 700);
      }
    });
  });

  // â”€â”€ Realtime leads listener â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function initLeadsListener() {
    const q = query(collection(db,"leads"), orderBy("createdAt","desc"), limit(10000));
    onSnapshot(q, snap => {
      allLeads = snap.docs
        .map(d => ({ id: d.id, ...d.data() }))
        .filter(x => x.createdAt && x.createdAt.toDate);
      computeStats();
    }, err => {
      console.error(err);
      toast("Error loading leads.");
    });
  }

  // â”€â”€ Compute & render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function computeStats() {
    const today0 = startOfToday();
    const d7 = startOf7DaysAgo();

    const todayLeads = allLeads.filter(e => e.createdAt.toDate() >= today0);
    const last7Leads = allLeads.filter(e => e.createdAt.toDate() >= d7);

    // Water fill
    setFill(allLeads.length);

    // Today counts per user (on buttons)
    TEAM.forEach(n => {
      const el = document.getElementById("today-" + n);
      if (el) el.textContent = todayLeads.filter(e => e.userName === n).length;
    });

    // Leaderboard
    renderLeaderboard(todayLeads, allLeads);

    // Trends
    renderTrends(allLeads, todayLeads, last7Leads);

    // User panels
    TEAM.forEach(n => renderUserPanel(n, allLeads));
  }

  function tally(events, keyFn) {
    const m = new Map();
    for (const e of events) {
      const k = keyFn(e);
      m.set(k, (m.get(k)||0)+1);
    }
    return [...m.entries()].sort((a,b) => b[1]-a[1]);
  }

  function renderLeaderboard(todayLeads, allLeads) {
    const tbody = (id, data) => {
      const el = document.getElementById(id);
      el.innerHTML = "";
      if (!data.length) { el.innerHTML = `<tr><td colspan="3" class="empty">No leads yet</td></tr>`; return; }
      data.forEach(([name, count], i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="rank">${i+1}</td>
          <td>${name}</td>
          <td class="count-cell">${count}</td>`;
        el.appendChild(tr);
      });
    };
    tbody("lb-today", tally(todayLeads, e => e.userName||"?"));
    tbody("lb-all",   tally(allLeads,   e => e.userName||"?"));
  }

  function renderTrends(all, todayLeads, last7) {
    document.getElementById("st-total").textContent = all.length;
    document.getElementById("st-today").textContent = todayLeads.length;
    document.getElementById("st-avg").textContent   = (last7.length / 7).toFixed(1);

    // Best day
    const byDay = new Map();
    all.forEach(e => {
      const d = e.createdAt.toDate().toDateString();
      byDay.set(d, (byDay.get(d)||0)+1);
    });
    const best = byDay.size ? Math.max(...byDay.values()) : 0;
    document.getElementById("st-best").textContent = best;

    // Bar chart per user (last 7 days)
    const bars = document.getElementById("trends-bars");
    bars.innerHTML = "";
    const maxVal = Math.max(1, ...TEAM.map(n => last7.filter(e=>e.userName===n).length));
    TEAM.forEach(n => {
      const cnt = last7.filter(e => e.userName===n).length;
      const pct = (cnt / maxVal * 100).toFixed(1);
      bars.innerHTML += `
        <div class="bar-row">
          <div class="bar-label">${n}</div>
          <div class="bar-track">
            <div class="bar-fill" style="width:${pct}%">${cnt > 0 ? cnt : ""}</div>
          </div>
        </div>`;
    });

    // Recent feed (last 15)
    const feed = document.getElementById("recent-feed");
    const recent = [...all].slice(0, 15);
    feed.innerHTML = recent.length ? recent.map(e => `
      <div class="feed-item">
        <div><span class="fi-name">${e.userName||"?"}</span>
          ${e.companyName ? `<span class="fi-co"> Â· ${e.companyName}</span>` : ""}
        </div>
        <div class="fi-time">${fmtTime(e.createdAt.toDate())}</div>
      </div>`).join("") : `<div class="empty">No leads yet.</div>`;
  }

  function renderUserPanel(name, all) {
    const el = document.getElementById("user-panel-" + name);
    if (!el) return;
    const userLeads = all.filter(e => e.userName === name);
    const today0 = startOfToday();
    const d7 = startOf7DaysAgo();
    const todayCnt = userLeads.filter(e => e.createdAt.toDate() >= today0).length;
    const last7Cnt = userLeads.filter(e => e.createdAt.toDate() >= d7).length;
    const allTime  = userLeads.length;

    // Companies
    const cos = tally(userLeads, e => e.companyName || "No company").slice(0,8);

    el.innerHTML = `
      <div class="stat-grid">
        <div class="stat-card"><div class="s-label">All-Time</div><div class="s-val">${allTime}</div></div>
        <div class="stat-card"><div class="s-label">Today</div><div class="s-val">${todayCnt}</div></div>
        <div class="stat-card"><div class="s-label">Last 7 Days</div><div class="s-val">${last7Cnt}</div></div>
        <div class="stat-card"><div class="s-label">7-Day Avg</div><div class="s-val">${(last7Cnt/7).toFixed(1)}</div></div>
      </div>
      ${cos.length ? `
        <div class="section-label">Top Companies</div>
        ${cos.map(([name, cnt]) => {
          const pct = (cnt / Math.max(1, cos[0][1]) * 100).toFixed(1);
          return `<div class="bar-row">
            <div class="bar-label" style="width:100px;font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${name}</div>
            <div class="bar-track"><div class="bar-fill" style="width:${pct}%">${cnt>0?cnt:""}</div></div>
          </div>`;
        }).join("")}
      ` : ""}
      <div class="section-label" style="margin-top:16px">Recent</div>
      ${userLeads.slice(0,10).map(e => `
        <div class="feed-item">
          <div class="fi-co">${e.companyName || "â€”"}</div>
          <div class="fi-time">${fmtTime(e.createdAt.toDate())}</div>
        </div>`).join("") || `<div class="empty">No leads yet.</div>`}
    `;
  }

  // â”€â”€ Modal / Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  statsBtn.addEventListener("click", () => modalBd.classList.add("open"));
  closeModal.addEventListener("click", () => modalBd.classList.remove("open"));
  modalBd.addEventListener("click", e => { if (e.target === modalBd) modalBd.classList.remove("open"); });

  tabBar.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      tabBar.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
      tab.classList.add("active");
      const panel = document.getElementById("panel-" + tab.dataset.tab);
      if (panel) panel.classList.add("active");
    });
  });
</script>
</body>
</html>
