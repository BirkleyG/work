<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lead Drop</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg: #060d1a;
      --card: #0d1929;
      --border: #1a2e50;
      --text: #e8eeff;
      --muted: #5a7aa8;
      --orange: #ff7a1a;
      --orange2: #ff5500;
      --orange-glow: rgba(255,122,26,0.28);
      --orange-light: #ffab5e;
      --gold: #ffc046;
    }
    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }
    body::before {
      content: "";
      position: fixed; inset: 0;
      background:
        radial-gradient(ellipse 80% 60% at 50% -10%, #0d2250 0%, transparent 65%),
        radial-gradient(ellipse 40% 40% at 80% 80%, #1a1000 0%, transparent 60%);
      pointer-events: none; z-index: 0;
    }

    .page {
      position: relative; z-index: 1;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
      padding: 28px 20px 48px;
    }

    /* â”€â”€ HEADER â”€â”€ */
    .header { text-align: center; margin-bottom: 8px; }
    .header h1 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(42px, 8vw, 72px);
      letter-spacing: 4px; margin: 0;
      background: linear-gradient(160deg, #fff 20%, var(--orange-light) 60%, var(--orange) 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
      line-height: 1;
      filter: drop-shadow(0 0 24px var(--orange-glow));
    }
    .header .sub {
      font-size: 13px; color: var(--muted);
      letter-spacing: 3px; text-transform: uppercase; margin-top: 4px;
    }

    /* â”€â”€ GOAL TICKER â”€â”€ */
    .goal-bar {
      margin-top: 14px;
      display: flex; align-items: center; gap: 12px;
      font-size: 13px; color: var(--muted);
    }
    .goal-bar .count {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 32px; color: var(--orange); line-height: 1; letter-spacing: 1px;
    }
    .goal-bar .slash { color: var(--border); font-size: 24px; }
    .goal-bar .goal-num {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 22px; color: var(--muted); letter-spacing: 1px;
    }

    /* â”€â”€ GLASS â”€â”€ */
    .glass-section {
      margin-top: 16px; position: relative;
      display: flex; justify-content: center;
    }
    .glass-stage {
      width: 200px; height: 290px;
      position: relative;
    }
    .glass-outer {
      position: absolute; inset: 0;
      border-radius: 28px 28px 40px 40px;
      border: 2px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
      overflow: hidden;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.04), 0 20px 60px rgba(0,0,0,0.6), inset 0 0 30px rgba(255,255,255,0.02);
    }
    .glass-outer::before {
      content: ""; position: absolute;
      top: 16px; left: 18px; width: 14px; height: 65%;
      border-radius: 999px; background: rgba(255,255,255,0.12); filter: blur(1px);
    }
    .water {
      position: absolute; left: 0; right: 0; bottom: 0; height: 0%;
      background: linear-gradient(180deg,
        rgba(255,155,50,0.95) 0%,
        rgba(255,80,0,0.88) 50%,
        rgba(190,45,0,0.92) 100%
      );
      transition: height 900ms cubic-bezier(0.2,0.9,0.2,1);
    }
    .water::after {
      content: ""; position: absolute;
      left: -20%; right: -20%; top: -12px;
      height: 24px;
      background: rgba(255,180,80,0.3);
      border-radius: 999px; filter: blur(3px);
    }
    .water-glow {
      position: absolute; left: 0; right: 0; bottom: 0; height: 0%;
      box-shadow: 0 0 50px 20px rgba(255,100,0,0.22);
      transition: height 900ms cubic-bezier(0.2,0.9,0.2,1);
      pointer-events: none; border-radius: 0 0 40px 40px;
    }
    .goal-line {
      position: absolute; left: 8px; right: 8px;
      border-top: 2px dashed rgba(255,255,255,0.18);
      pointer-events: none;
    }
    /* Canvas for splash animation */
    .splash-canvas {
      position: absolute; inset: 0;
      width: 200px; height: 290px;
      pointer-events: none; z-index: 10;
      border-radius: 28px 28px 40px 40px;
      overflow: visible;
    }
    .pct-label {
      position: absolute; bottom: 10px; width: 100%;
      text-align: center;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 28px; letter-spacing: 1px;
      color: rgba(255,255,255,0.9);
      text-shadow: 0 2px 8px rgba(0,0,0,0.6);
      pointer-events: none; z-index: 5;
    }

    /* â”€â”€ BATCH TOGGLE â”€â”€ */
    .batch-row {
      margin-top: 16px;
      display: flex; align-items: center; gap: 12px;
    }
    .batch-label {
      font-size: 13px; color: var(--muted);
      letter-spacing: 1px; text-transform: uppercase;
    }
    .toggle-wrap {
      position: relative; width: 48px; height: 26px;
      cursor: pointer;
    }
    .toggle-wrap input { opacity: 0; width: 0; height: 0; }
    .toggle-track {
      position: absolute; inset: 0;
      border-radius: 999px;
      background: var(--border);
      border: 1px solid #2a4070;
      transition: background 250ms, box-shadow 250ms;
    }
    .toggle-thumb {
      position: absolute;
      top: 3px; left: 3px;
      width: 18px; height: 18px;
      border-radius: 50%;
      background: var(--muted);
      transition: transform 250ms cubic-bezier(0.34,1.56,0.64,1), background 250ms;
    }
    .toggle-wrap input:checked ~ .toggle-track {
      background: var(--orange);
      box-shadow: 0 0 14px var(--orange-glow);
    }
    .toggle-wrap input:checked ~ .toggle-thumb {
      transform: translateX(22px);
      background: #fff;
    }

    /* â”€â”€ USER BUTTONS â”€â”€ */
    .btn-grid {
      margin-top: 16px;
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
      width: min(420px, 100%);
    }
    .user-btn {
      position: relative; overflow: hidden;
      padding: 16px 12px; border-radius: 16px;
      border: 1.5px solid var(--border);
      background: linear-gradient(160deg, #0e1e38, #091428);
      color: var(--text); cursor: pointer;
      transition: transform 80ms, border-color 250ms, box-shadow 250ms, background 250ms;
      display: flex; flex-direction: column; align-items: center; gap: 3px;
    }
    .user-btn .plus {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 26px; line-height: 1; color: var(--orange);
    }
    .user-btn .name { font-size: 13px; letter-spacing: 1px; color: var(--muted); font-weight: 600; }
    .user-btn .today { font-size: 20px; font-weight: 800; color: #fff; }
    .user-btn:hover {
      border-color: var(--orange);
      box-shadow: 0 0 20px var(--orange-glow), inset 0 0 20px rgba(255,122,26,0.04);
      transform: translateY(-1px);
    }
    .user-btn:active { transform: scale(0.97); }
    .user-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    /* Batch mode highlight */
    .user-btn.batch-mode {
      border-color: var(--orange);
      background: linear-gradient(160deg, #1e1205, #140d03);
      box-shadow: 0 0 22px var(--orange-glow), inset 0 0 30px rgba(255,122,26,0.06);
    }
    .user-btn.batch-mode .plus { color: var(--orange-light); }
    .user-btn.batch-mode .name { color: var(--orange); }
    .user-btn .ripple-circle {
      position: absolute; border-radius: 50%;
      background: rgba(255,122,26,0.25);
      transform: scale(0);
      animation: btn-ripple 500ms ease-out forwards;
      pointer-events: none;
    }
    @keyframes btn-ripple { to { transform: scale(4); opacity: 0; } }
    .user-btn::after {
      content: ""; position: absolute; inset: 0;
      background: radial-gradient(circle at center, rgba(255,122,26,0.18), transparent 70%);
      opacity: 0; transition: opacity 0.15s; border-radius: 16px;
    }
    .user-btn.flash::after { opacity: 1; }

    /* â”€â”€ BATCH INPUT MODAL â”€â”€ */
    .batch-input-overlay {
      position: fixed; inset: 0;
      background: rgba(4,9,20,0.7);
      backdrop-filter: blur(4px);
      display: none; align-items: center; justify-content: center;
      z-index: 2000;
    }
    .batch-input-overlay.open { display: flex; }
    .batch-dialog {
      background: linear-gradient(160deg, #0e1e38, #091428);
      border: 1.5px solid var(--orange);
      border-radius: 20px; padding: 28px 24px;
      min-width: 280px; text-align: center;
      box-shadow: 0 0 40px var(--orange-glow), 0 20px 60px rgba(0,0,0,0.6);
      animation: pop-in 200ms cubic-bezier(0.34,1.56,0.64,1);
    }
    @keyframes pop-in { from { transform: scale(0.85); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .batch-dialog .bd-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 28px; letter-spacing: 2px; color: var(--orange-light);
      margin-bottom: 6px;
    }
    .batch-dialog .bd-sub { font-size: 13px; color: var(--muted); margin-bottom: 18px; }
    .batch-num-input {
      width: 100%; padding: 14px;
      background: #060d1a; border: 1.5px solid var(--border);
      border-radius: 12px; color: #fff;
      font-family: 'Bebas Neue', sans-serif; font-size: 36px;
      text-align: center; outline: none;
      transition: border-color 150ms;
    }
    .batch-num-input:focus { border-color: var(--orange); }
    .batch-btns { display: flex; gap: 10px; margin-top: 16px; }
    .batch-confirm {
      flex: 1; padding: 13px;
      border-radius: 12px; border: none;
      background: linear-gradient(160deg, #ff7a1a, #c44400);
      color: #fff; font-family: 'DM Sans', sans-serif;
      font-size: 15px; font-weight: 700; cursor: pointer;
      transition: opacity 150ms;
    }
    .batch-confirm:hover { opacity: 0.9; }
    .batch-cancel {
      padding: 13px 18px;
      border-radius: 12px; border: 1px solid var(--border);
      background: transparent; color: var(--muted);
      font-size: 14px; cursor: pointer;
      transition: border-color 150ms;
    }
    .batch-cancel:hover { border-color: var(--orange); color: var(--orange-light); }

    /* â”€â”€ STATS BTN â”€â”€ */
    .stats-btn-wrap { margin-top: 28px; }
    .stats-btn {
      padding: 14px 40px; border-radius: 999px;
      border: 1.5px solid var(--border);
      background: linear-gradient(160deg, #0e1e38, #091428);
      color: var(--muted); font-family: 'DM Sans', sans-serif;
      font-size: 14px; font-weight: 600;
      letter-spacing: 2px; text-transform: uppercase; cursor: pointer;
      transition: all 200ms;
    }
    .stats-btn:hover {
      border-color: var(--orange); color: var(--orange-light);
      box-shadow: 0 0 20px var(--orange-glow);
    }

    /* â”€â”€ TOAST â”€â”€ */
    .toast {
      position: fixed; top: 16px; left: 50%; transform: translateX(-50%);
      background: #0e1929; border: 1px solid var(--orange);
      padding: 10px 18px; border-radius: 12px; font-size: 13px; color: var(--orange-light);
      box-shadow: 0 0 20px var(--orange-glow);
      opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 9999;
      white-space: nowrap;
    }
    .toast.show { opacity: 1; }

    /* â”€â”€ MODAL â”€â”€ */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(4,9,20,0.85); backdrop-filter: blur(6px);
      display: none; align-items: flex-end; justify-content: center;
      z-index: 1000; padding: 0;
    }
    .modal-backdrop.open { display: flex; }
    .modal {
      width: min(820px, 100%); max-height: 88vh;
      background: linear-gradient(180deg, #0e1a2e, #091220);
      border: 1px solid var(--border);
      border-radius: 24px 24px 0 0;
      display: flex; flex-direction: column; overflow: hidden;
      box-shadow: 0 -20px 60px rgba(0,0,0,0.7);
      animation: slide-up 300ms cubic-bezier(0.2,0.9,0.2,1);
    }
    @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-handle {
      width: 40px; height: 4px; background: var(--border);
      border-radius: 999px; margin: 12px auto 0; flex-shrink: 0;
    }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 20px 0; flex-shrink: 0;
    }
    .modal-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 26px; letter-spacing: 2px;
    }
    .close-btn {
      width: 32px; height: 32px; border-radius: 50%;
      border: 1px solid var(--border); background: transparent;
      color: var(--muted); font-size: 18px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 150ms; line-height: 1;
    }
    .close-btn:hover { border-color: var(--orange); color: var(--orange); }
    .tabs {
      display: flex; gap: 4px;
      padding: 12px 20px 0; overflow-x: auto; flex-shrink: 0;
      scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar { display: none; }
    .tab {
      padding: 8px 16px; border-radius: 10px;
      border: 1px solid transparent; background: transparent;
      color: var(--muted); font-family: 'DM Sans', sans-serif;
      font-size: 13px; font-weight: 600; cursor: pointer;
      white-space: nowrap; transition: all 150ms;
    }
    .tab:hover { color: var(--text); }
    .tab.active { background: #0e1e38; border-color: var(--border); color: var(--orange-light); }
    .tab-content { flex: 1; overflow-y: auto; padding: 16px 20px 24px; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .tab-content::-webkit-scrollbar { width: 4px; }
    .tab-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 999px; }

    /* â”€â”€ LEADERBOARD PANEL â”€â”€ */
    .lb-compare {
      display: flex; flex-direction: column; gap: 14px;
      margin-bottom: 20px;
    }
    .lb-row {
      background: #0a1626; border: 1px solid var(--border);
      border-radius: 14px; padding: 14px 16px;
      display: flex; align-items: center; gap: 14px;
      position: relative; overflow: hidden;
      transition: border-color 200ms;
    }
    .lb-row:nth-child(1) { border-color: rgba(255,192,70,0.4); }
    .lb-row:nth-child(2) { border-color: rgba(192,192,192,0.3); }
    .lb-row:nth-child(3) { border-color: rgba(205,127,50,0.3); }
    .lb-row .rank-badge {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 26px; line-height: 1;
      width: 30px; flex-shrink: 0; text-align: center;
    }
    .lb-row:nth-child(1) .rank-badge { color: var(--gold); }
    .lb-row:nth-child(2) .rank-badge { color: #c0c0c0; }
    .lb-row:nth-child(3) .rank-badge { color: #cd7f32; }
    .lb-row:nth-child(4) .rank-badge { color: var(--muted); }
    .lb-row .lb-name {
      font-weight: 700; font-size: 15px; width: 80px; flex-shrink: 0;
    }
    .lb-row .lb-bars { flex: 1; display: flex; flex-direction: column; gap: 5px; }
    .mini-bar-row { display: flex; align-items: center; gap: 6px; }
    .mini-bar-label { font-size: 10px; color: var(--muted); letter-spacing: 1px; width: 30px; flex-shrink: 0; }
    .mini-bar-track {
      flex: 1; height: 16px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 4px; overflow: hidden;
    }
    .mini-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--orange2), var(--orange));
      border-radius: 4px;
      display: flex; align-items: center; justify-content: flex-end;
      padding-right: 6px;
      font-size: 10px; font-weight: 700; color: rgba(255,255,255,0.9);
      min-width: 2px;
      transition: width 700ms cubic-bezier(0.2,0.9,0.2,1);
    }
    .mini-bar-fill.today-bar { background: linear-gradient(90deg, #1a6e3a, #2ade80); }
    .mini-bar-fill.avg-bar { background: linear-gradient(90deg, #1a3e8e, #5aabff); }
    .lb-row .lb-nums {
      display: flex; flex-direction: column; align-items: flex-end; gap: 2px; flex-shrink: 0;
    }
    .lb-num-big {
      font-family: 'Bebas Neue', sans-serif; font-size: 28px;
      color: var(--orange); line-height: 1; letter-spacing: 1px;
    }
    .lb-num-small { font-size: 11px; color: var(--muted); }
    .lb-avg-val {
      font-family: 'Bebas Neue', sans-serif; font-size: 16px;
      color: #5aabff; letter-spacing: 1px;
    }

    .section-label {
      font-size: 11px; letter-spacing: 2px; text-transform: uppercase;
      color: var(--muted); margin: 14px 0 10px;
      padding-bottom: 6px; border-bottom: 1px solid var(--border);
    }

    /* â”€â”€ GENERAL / USER PANELS â”€â”€ */
    .stat-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 10px; margin-bottom: 18px;
    }
    .stat-card {
      background: #0a1626; border: 1px solid var(--border);
      border-radius: 14px; padding: 14px 12px;
    }
    .stat-card .s-label { font-size: 11px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }
    .stat-card .s-val {
      font-family: 'Bebas Neue', sans-serif; font-size: 32px;
      color: var(--orange-light); letter-spacing: 1px; line-height: 1.1; margin-top: 4px;
    }
    .bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .bar-label { font-size: 13px; color: var(--muted); width: 80px; flex-shrink: 0; }
    .bar-track {
      flex: 1; height: 22px; background: #0a1626;
      border: 1px solid var(--border); border-radius: 6px; overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--orange2), var(--orange));
      border-radius: 6px;
      display: flex; align-items: center; justify-content: flex-end; padding-right: 8px;
      font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.9);
      min-width: 2px;
      transition: width 600ms cubic-bezier(0.2,0.9,0.2,1);
    }
    .feed-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 9px 0; border-bottom: 1px solid rgba(26,46,80,0.4);
      font-size: 13px;
    }
    .feed-item:last-child { border-bottom: none; }
    .fi-name { color: var(--text); font-weight: 600; }
    .fi-co { color: var(--muted); }
    .fi-time { font-size: 11px; color: var(--muted); }
    .empty { color: var(--muted); font-size: 13px; padding: 12px 0; }

    @media (max-width: 480px) {
      .lb-row { flex-wrap: wrap; }
      .lb-name { width: 60px; }
    }
  </style>
</head>
<body>
<div class="toast" id="toast"></div>

<!-- Batch input dialog -->
<div class="batch-input-overlay" id="batchOverlay">
  <div class="batch-dialog">
    <div class="bd-title" id="bd-title">Add Leads</div>
    <div class="bd-sub" id="bd-sub">How many leads did you add?</div>
    <input class="batch-num-input" id="batchNumInput" type="number" min="1" max="999" value="1"/>
    <div class="batch-btns">
      <button class="batch-cancel" id="batchCancel">Cancel</button>
      <button class="batch-confirm" id="batchConfirm">Add Leads</button>
    </div>
  </div>
</div>

<div class="page">
  <div class="header">
    <h1>Lead Drop</h1>
    <div class="sub">Every lead fills the glass</div>
  </div>

  <div class="goal-bar">
    <div>
      <span class="count" id="totalCount">0</span>
      <span class="slash"> /</span>
      <span class="goal-num" id="goalNum">â€”</span>
    </div>
    <div style="color:var(--muted);font-size:12px">ALL-TIME LEADS</div>
  </div>

  <!-- Glass -->
  <div class="glass-section">
    <div class="glass-stage" id="glassStage">
      <div class="glass-outer">
        <div class="water" id="water"></div>
        <div class="water-glow" id="waterGlow"></div>
        <div class="goal-line" id="goalLine" style="top:6%"></div>
      </div>
      <canvas class="splash-canvas" id="splashCanvas" width="200" height="290"></canvas>
      <div class="pct-label" id="pctLabel">0%</div>
    </div>
  </div>

  <!-- Batch toggle -->
  <div class="batch-row">
    <span class="batch-label">Batch Add</span>
    <label class="toggle-wrap">
      <input type="checkbox" id="batchToggle"/>
      <div class="toggle-track"></div>
      <div class="toggle-thumb"></div>
    </label>
  </div>

  <!-- User buttons -->
  <div class="btn-grid">
    <button class="user-btn" id="btn-Alston" data-user="Alston" disabled>
      <span class="plus">+1</span>
      <span class="today" id="today-Alston">0</span>
      <span class="name">ALSTON</span>
    </button>
    <button class="user-btn" id="btn-Jennifer" data-user="Jennifer" disabled>
      <span class="plus">+1</span>
      <span class="today" id="today-Jennifer">0</span>
      <span class="name">JENNIFER</span>
    </button>
    <button class="user-btn" id="btn-Lina" data-user="Lina" disabled>
      <span class="plus">+1</span>
      <span class="today" id="today-Lina">0</span>
      <span class="name">LINA</span>
    </button>
    <button class="user-btn" id="btn-Ziyu" data-user="Ziyu" disabled>
      <span class="plus">+1</span>
      <span class="today" id="today-Ziyu">0</span>
      <span class="name">ZIYU</span>
    </button>
  </div>

  <div class="stats-btn-wrap">
    <button class="stats-btn" id="statsBtn">ðŸ“Š View Stats</button>
  </div>
</div>

<!-- STATS MODAL -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title">Performance Stats</div>
      <button class="close-btn" id="closeModal">âœ•</button>
    </div>
    <div class="tabs" id="tabBar">
      <button class="tab active" data-tab="leaderboard">Leaderboard</button>
      <button class="tab" data-tab="general">General</button>
      <button class="tab" data-tab="Alston">Alston</button>
      <button class="tab" data-tab="Jennifer">Jennifer</button>
      <button class="tab" data-tab="Lina">Lina</button>
      <button class="tab" data-tab="Ziyu">Ziyu</button>
    </div>
    <div class="tab-content">

      <!-- Leaderboard -->
      <div class="tab-panel active" id="panel-leaderboard">
        <div class="section-label">Today â€” Head to Head</div>
        <div class="lb-compare" id="lb-today-compare"></div>
        <div class="section-label">All-Time â€” Head to Head</div>
        <div class="lb-compare" id="lb-all-compare"></div>
      </div>

      <!-- General -->
      <div class="tab-panel" id="panel-general">
        <div class="stat-grid">
          <div class="stat-card"><div class="s-label">Total All-Time</div><div class="s-val" id="st-total">â€”</div></div>
          <div class="stat-card"><div class="s-label">Today (Team)</div><div class="s-val" id="st-today">â€”</div></div>
          <div class="stat-card"><div class="s-label">7-Day Avg/day</div><div class="s-val" id="st-avg">â€”</div></div>
          <div class="stat-card"><div class="s-label">Best Single Day</div><div class="s-val" id="st-best">â€”</div></div>
        </div>
        <div class="section-label">Last 7 Days by Person</div>
        <div id="trends-bars"></div>
        <div class="section-label" style="margin-top:20px">Recent Activity</div>
        <div id="recent-feed"></div>
      </div>

      <!-- Per-user panels -->
      <div class="tab-panel" id="panel-Alston"><div id="user-panel-Alston"></div></div>
      <div class="tab-panel" id="panel-Jennifer"><div id="user-panel-Jennifer"></div></div>
      <div class="tab-panel" id="panel-Lina"><div id="user-panel-Lina"></div></div>
      <div class="tab-panel" id="panel-Ziyu"><div id="user-panel-Ziyu"></div></div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, doc, getDoc, setDoc, addDoc,
    query, orderBy, limit, onSnapshot, serverTimestamp, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getAuth, signInAnonymously, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  FIREBASE CONFIG
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const firebaseConfig = {
    apiKey: "AIzaSyD_lk0-JE861RqFt9dZR1YMRl-qr_9xHtU",
    authDomain: "lead-tracker-c13ca.firebaseapp.com",
    projectId: "lead-tracker-c13ca",
    storageBucket: "lead-tracker-c13ca.firebasestorage.app",
    messagingSenderId: "590497117694",
    appId: "1:590497117694:web:dc071c3b8506273667fcaf",
    measurementId: "G-Q3NW44KW1K"
  };

  const TEAM = ["Alston","Jennifer","Lina","Ziyu"];
  let GOAL = 100; // will be overridden from Firestore

  const app  = initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  DOM
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const waterEl        = document.getElementById("water");
  const waterGlow      = document.getElementById("waterGlow");
  const splashCanvas   = document.getElementById("splashCanvas");
  const ctx            = splashCanvas.getContext("2d");
  const pctLabel       = document.getElementById("pctLabel");
  const totalCount     = document.getElementById("totalCount");
  const goalNumEl      = document.getElementById("goalNum");
  const toastEl        = document.getElementById("toast");
  const statsBtn       = document.getElementById("statsBtn");
  const modalBd        = document.getElementById("modalBackdrop");
  const closeModal     = document.getElementById("closeModal");
  const tabBar         = document.getElementById("tabBar");
  const batchToggle    = document.getElementById("batchToggle");
  const batchOverlay   = document.getElementById("batchOverlay");
  const batchNumInput  = document.getElementById("batchNumInput");
  const batchConfirm   = document.getElementById("batchConfirm");
  const batchCancel    = document.getElementById("batchCancel");
  const bdTitle        = document.getElementById("bd-title");
  const bdSub          = document.getElementById("bd-sub");

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  TOAST
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(() => toastEl.classList.remove("show"), 2400);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  HELPERS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startOfToday() { const d=new Date(); d.setHours(0,0,0,0); return d; }
  function startOf7DaysAgo() { return new Date(Date.now()-7*86400000); }
  function fmtTime(date) {
    const diff = (Date.now()-date)/1000;
    if (diff<60) return "just now";
    if (diff<3600) return Math.floor(diff/60)+"m ago";
    if (diff<86400) return Math.floor(diff/3600)+"h ago";
    return date.toLocaleDateString("en-US",{month:"short",day:"numeric"});
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  WATER FILL
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let currentFillPct = 0;
  function setFill(total) {
    const pct = GOAL > 0 ? Math.min(100, (total/GOAL)*100) : 0;
    currentFillPct = pct;
    const h = pct.toFixed(1)+"%";
    waterEl.style.height = h;
    waterGlow.style.height = h;
    pctLabel.textContent = Math.round(pct)+"%";
    totalCount.textContent = total;
    goalNumEl.textContent = GOAL;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  SPLASH ANIMATION (canvas)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const CW = 200, CH = 290;
  let animFrame = null;
  let particles = [];
  let ripples   = [];
  let dropPhase = null; // { y, vy } while falling

  function getWaterSurfaceY() {
    // currentFillPct 0â€“100 maps to CH down to 0
    return CH - (currentFillPct/100)*CH;
  }

  function launchSplash() {
    const surfaceY = getWaterSurfaceY();
    const cx = CW / 2;

    // 1) Falling teardrop phase
    dropPhase = { y: -10, vy: 2.5 };

    // 2) On impact: create splash particles
    //    (scheduled once drop reaches surface)
    const numParticles = 28;
    for (let i = 0; i < numParticles; i++) {
      const angle = (Math.PI * (0.15 + 0.7 * Math.random())) + Math.PI; // spray upward
      const speed = 2.5 + Math.random() * 7;
      const size  = 2.5 + Math.random() * 5;
      particles.push({
        x: cx, y: surfaceY,
        vx: Math.cos(angle) * speed,
        vy: Math.sin(angle) * speed,
        gravity: 0.28 + Math.random()*0.12,
        alpha: 0.9 + Math.random()*0.1,
        size,
        born: false // will set true on impact
      });
    }
    // a few big crown drops
    for (let i = 0; i < 6; i++) {
      const angle = (Math.PI * (0.05 + 0.9 * (i/5))) + Math.PI;
      particles.push({
        x: cx, y: surfaceY,
        vx: Math.cos(angle) * (4+i*1.5),
        vy: -8 - Math.random()*5,
        gravity: 0.22,
        alpha: 1,
        size: 5 + Math.random()*4,
        born: false
      });
    }

    // 3) Ripple rings
    ripples = [
      { y: surfaceY, r: 0, maxR: 70, alpha: 0.7, speed: 2.2, born: false },
      { y: surfaceY, r: 0, maxR: 45, alpha: 0.5, speed: 1.5, born: false, delay: 80 },
      { y: surfaceY, r: 0, maxR: 30, alpha: 0.35, speed: 1.1, born: false, delay: 140 },
    ];

    if (!animFrame) animate();
  }

  function triggerImpact() {
    particles.forEach(p => p.born = true);
    ripples.forEach(r => r.born = true);
    dropPhase = null;
  }

  let impactScheduled = false;
  function animate() {
    ctx.clearRect(0, 0, CW, CH);
    const surfaceY = getWaterSurfaceY();

    let hasActivity = false;

    // â”€â”€ Falling teardrop â”€â”€
    if (dropPhase) {
      dropPhase.vy += 0.45; // gravity
      dropPhase.y  += dropPhase.vy;

      const y = dropPhase.y;
      const x = CW / 2;

      // Draw teardrop
      ctx.save();
      const grd = ctx.createLinearGradient(x-8, y-14, x+8, y+8);
      grd.addColorStop(0, "rgba(255,210,120,0.95)");
      grd.addColorStop(1, "rgba(255,80,0,0.95)");
      ctx.fillStyle = grd;
      ctx.shadowColor = "rgba(255,120,0,0.6)";
      ctx.shadowBlur  = 10;
      ctx.beginPath();
      ctx.moveTo(x, y-14);
      ctx.bezierCurveTo(x+9, y-4, x+9, y+4, x, y+8);
      ctx.bezierCurveTo(x-9, y+4, x-9, y-4, x, y-14);
      ctx.fill();
      ctx.restore();

      // Check impact
      if (dropPhase.y + 8 >= surfaceY && !impactScheduled) {
        impactScheduled = true;
        triggerImpact();
      }
      hasActivity = true;
    }

    // â”€â”€ Ripples â”€â”€
    ripples.forEach(r => {
      if (!r.born) { hasActivity = true; return; }
      r.r += r.speed;
      r.alpha *= 0.968;
      if (r.r < r.maxR && r.alpha > 0.02) {
        const scaleX = 1.0;
        const scaleY = 0.32;
        ctx.save();
        ctx.translate(CW/2, r.y);
        ctx.scale(scaleX, scaleY);
        ctx.strokeStyle = `rgba(255,160,60,${r.alpha})`;
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.arc(0, 0, r.r, 0, Math.PI*2);
        ctx.stroke();
        ctx.restore();
        hasActivity = true;
      }
    });

    // â”€â”€ Particles â”€â”€
    particles = particles.filter(p => {
      if (!p.born) { hasActivity = true; return true; }
      p.vy += p.gravity;
      p.x  += p.vx;
      p.y  += p.vy;
      p.alpha *= 0.97;
      p.vx *= 0.992;

      if (p.alpha < 0.03 || p.y > CH + 20) return false;

      const grd = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size);
      grd.addColorStop(0, `rgba(255,200,80,${p.alpha})`);
      grd.addColorStop(1, `rgba(255,80,0,${p.alpha*0.4})`);

      ctx.save();
      ctx.shadowColor = `rgba(255,130,0,${p.alpha*0.5})`;
      ctx.shadowBlur  = 6;
      ctx.fillStyle   = grd;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
      hasActivity = true;
      return true;
    });

    if (hasActivity) {
      animFrame = requestAnimationFrame(animate);
    } else {
      ctx.clearRect(0, 0, CW, CH);
      animFrame = null;
      impactScheduled = false;
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  BUTTON RIPPLE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function btnRipple(btn) {
    const r = document.createElement("span");
    r.className = "ripple-circle";
    const sz = Math.max(btn.offsetWidth, btn.offsetHeight);
    r.style.cssText = `width:${sz}px;height:${sz}px;left:${btn.offsetWidth/2-sz/2}px;top:${btn.offsetHeight/2-sz/2}px`;
    btn.appendChild(r);
    r.addEventListener("animationend", () => r.remove());
    btn.classList.add("flash");
    setTimeout(() => btn.classList.remove("flash"), 200);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  BATCH TOGGLE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let batchMode = false;
  batchToggle.addEventListener("change", () => {
    batchMode = batchToggle.checked;
    TEAM.forEach(n => {
      const b = document.getElementById("btn-"+n);
      if (!b) return;
      b.classList.toggle("batch-mode", batchMode);
      b.querySelector(".plus").textContent = batchMode ? "N+" : "+1";
    });
  });

  // Batch dialog state
  let pendingBatchUser = null;
  function openBatchDialog(name) {
    pendingBatchUser = name;
    bdTitle.textContent = name;
    bdSub.textContent   = "How many leads to add?";
    batchNumInput.value = "1";
    batchOverlay.classList.add("open");
    setTimeout(() => { batchNumInput.focus(); batchNumInput.select(); }, 50);
  }
  batchCancel.addEventListener("click", () => {
    batchOverlay.classList.remove("open");
    pendingBatchUser = null;
  });
  batchNumInput.addEventListener("keydown", e => {
    if (e.key === "Enter") batchConfirm.click();
    if (e.key === "Escape") batchCancel.click();
  });
  batchConfirm.addEventListener("click", async () => {
    const n = parseInt(batchNumInput.value, 10);
    if (!n || n < 1 || n > 999) return toast("Enter a valid number (1â€“999).");
    batchOverlay.classList.remove("open");
    const name = pendingBatchUser;
    pendingBatchUser = null;
    await submitLeads(name, n);
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  AUTH
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let uid = null;
  let listenersStarted = false;
  let allLeads = [];

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      uid = user.uid;
      enableButtons();
      if (!listenersStarted) { listenersStarted = true; await loadSettings(); initLeadsListener(); }
    } else {
      try { await signInAnonymously(auth); }
      catch(e) { toast("Auth error â€” check Firebase Anonymous Auth."); console.error(e); }
    }
  });

  function enableButtons() {
    TEAM.forEach(n => { const b=document.getElementById("btn-"+n); if(b) b.disabled=false; });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  SETTINGS (read goal from Firestore)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadSettings() {
    try {
      const ref  = doc(db,"settings","global");
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        if (typeof data.goal === "number") GOAL = data.goal;
      } else {
        // Create default if missing
        await setDoc(ref, { goal: 100 });
      }
    } catch(e) { console.warn("Could not load settings:", e); }
    goalNumEl.textContent = GOAL;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  LEAD BUTTONS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  TEAM.forEach(name => {
    const btn = document.getElementById("btn-"+name);
    if (!btn) return;
    btn.addEventListener("click", () => {
      if (!uid) return toast("Not signed in yetâ€¦");
      if (batchMode) {
        openBatchDialog(name);
      } else {
        submitLeads(name, 1);
      }
    });
  });

  async function submitLeads(name, count) {
    const btn = document.getElementById("btn-"+name);
    if (btn) btn.disabled = true;

    launchSplash();
    if (btn) btnRipple(btn);

    try {
      if (count === 1) {
        await addDoc(collection(db,"leads"), {
          createdAt: serverTimestamp(), userName: name,
          companyId: "", companyName: ""
        });
      } else {
        // Use batched writes for multiple leads
        const CHUNK = 499;
        for (let offset = 0; offset < count; offset += CHUNK) {
          const batch = writeBatch(db);
          const chunk = Math.min(CHUNK, count - offset);
          for (let i = 0; i < chunk; i++) {
            batch.set(doc(collection(db,"leads")), {
              createdAt: serverTimestamp(), userName: name,
              companyId: "", companyName: ""
            });
          }
          await batch.commit();
        }
        toast(`Added ${count} leads for ${name}!`);
      }
    } catch(e) {
      toast("Could not save lead(s)."); console.error(e);
    } finally {
      setTimeout(() => { if(btn) btn.disabled=false; }, 700);
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  REALTIME LEADS LISTENER
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function initLeadsListener() {
    const q = query(collection(db,"leads"), orderBy("createdAt","desc"), limit(10000));
    onSnapshot(q, snap => {
      allLeads = snap.docs.map(d=>({id:d.id,...d.data()})).filter(x=>x.createdAt&&x.createdAt.toDate);
      computeStats();
    }, err => { console.error(err); toast("Error loading leads."); });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  COMPUTE & RENDER
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function computeStats() {
    const today0 = startOfToday();
    const d7     = startOf7DaysAgo();
    const todayLeads = allLeads.filter(e=>e.createdAt.toDate()>=today0);
    const last7Leads = allLeads.filter(e=>e.createdAt.toDate()>=d7);

    setFill(allLeads.length);

    TEAM.forEach(n => {
      const el = document.getElementById("today-"+n);
      if (el) el.textContent = todayLeads.filter(e=>e.userName===n).length;
    });

    renderLeaderboard(todayLeads, allLeads, last7Leads);
    renderGeneral(allLeads, todayLeads, last7Leads);
    TEAM.forEach(n => renderUserPanel(n, allLeads));
  }

  function tally(events, keyFn) {
    const m = new Map();
    for (const e of events) { const k=keyFn(e); m.set(k,(m.get(k)||0)+1); }
    return [...m.entries()].sort((a,b)=>b[1]-a[1]);
  }

  // â”€â”€â”€ LEADERBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderLeaderboard(todayLeads, allLeads, last7Leads) {
    renderCompareBlock("lb-today-compare", todayLeads, last7Leads, "today");
    renderCompareBlock("lb-all-compare",   allLeads,   last7Leads, "all");
  }

  function renderCompareBlock(containerId, leads, last7Leads, mode) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";

    // Build sorted rows
    const userStats = TEAM.map(name => {
      const total   = leads.filter(e=>e.userName===name).length;
      const last7   = last7Leads.filter(e=>e.userName===name).length;
      const avgDay  = (last7/7).toFixed(1);
      const today   = (function(){ const t=startOfToday(); return leads.filter(e=>e.userName===name && e.createdAt.toDate()>=t).length; })();
      return { name, total, last7, avgDay: parseFloat(avgDay), today };
    }).sort((a,b) => b.total - a.total);

    const maxTotal = Math.max(1, ...userStats.map(u=>u.total));
    const maxToday = Math.max(1, ...userStats.map(u=>u.today));
    const maxAvg   = Math.max(0.1, ...userStats.map(u=>u.avgDay));

    userStats.forEach((u, i) => {
      const totalPct = (u.total/maxTotal*100).toFixed(1);
      const todayPct = (u.today/maxToday*100).toFixed(1);
      const avgPct   = (u.avgDay/maxAvg*100).toFixed(1);

      const row = document.createElement("div");
      row.className = "lb-row";
      row.innerHTML = `
        <div class="rank-badge">${i+1}</div>
        <div class="lb-name">${u.name}</div>
        <div class="lb-bars">
          <div class="mini-bar-row">
            <div class="mini-bar-label">ALL</div>
            <div class="mini-bar-track"><div class="mini-bar-fill" style="width:${totalPct}%">${u.total>0?u.total:""}</div></div>
          </div>
          <div class="mini-bar-row">
            <div class="mini-bar-label">TODAY</div>
            <div class="mini-bar-track"><div class="mini-bar-fill today-bar" style="width:${todayPct}%">${u.today>0?u.today:""}</div></div>
          </div>
          <div class="mini-bar-row">
            <div class="mini-bar-label">AVG</div>
            <div class="mini-bar-track"><div class="mini-bar-fill avg-bar" style="width:${avgPct}%">${u.avgDay>0?u.avgDay:""}</div></div>
          </div>
        </div>
        <div class="lb-nums">
          <div class="lb-num-big">${u.total}</div>
          <div class="lb-avg-val">${u.avgDay}/d</div>
        </div>
      `;
      container.appendChild(row);
    });
  }

  // â”€â”€â”€ GENERAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderGeneral(all, todayLeads, last7) {
    document.getElementById("st-total").textContent = all.length;
    document.getElementById("st-today").textContent = todayLeads.length;
    document.getElementById("st-avg").textContent   = (last7.length/7).toFixed(1);

    const byDay = new Map();
    all.forEach(e => { const d=e.createdAt.toDate().toDateString(); byDay.set(d,(byDay.get(d)||0)+1); });
    document.getElementById("st-best").textContent = byDay.size ? Math.max(...byDay.values()) : 0;

    const bars = document.getElementById("trends-bars");
    bars.innerHTML = "";
    const maxV = Math.max(1, ...TEAM.map(n=>last7.filter(e=>e.userName===n).length));
    TEAM.forEach(n => {
      const cnt = last7.filter(e=>e.userName===n).length;
      bars.innerHTML += `<div class="bar-row">
        <div class="bar-label">${n}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${(cnt/maxV*100).toFixed(1)}%">${cnt>0?cnt:""}</div></div>
      </div>`;
    });

    const feed = document.getElementById("recent-feed");
    const recent = [...all].slice(0,15);
    feed.innerHTML = recent.length ? recent.map(e=>`
      <div class="feed-item">
        <div><span class="fi-name">${e.userName||"?"}</span>
          ${e.companyName?`<span class="fi-co"> Â· ${e.companyName}</span>`:""}
        </div>
        <div class="fi-time">${fmtTime(e.createdAt.toDate())}</div>
      </div>`).join("") : `<div class="empty">No leads yet.</div>`;
  }

  // â”€â”€â”€ USER PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderUserPanel(name, all) {
    const el = document.getElementById("user-panel-"+name);
    if (!el) return;
    const userLeads = all.filter(e=>e.userName===name);
    const today0 = startOfToday(), d7 = startOf7DaysAgo();
    const todayCnt = userLeads.filter(e=>e.createdAt.toDate()>=today0).length;
    const last7Cnt = userLeads.filter(e=>e.createdAt.toDate()>=d7).length;
    const cos = tally(userLeads, e=>e.companyName||"No company").slice(0,8);

    el.innerHTML = `
      <div class="stat-grid">
        <div class="stat-card"><div class="s-label">All-Time</div><div class="s-val">${userLeads.length}</div></div>
        <div class="stat-card"><div class="s-label">Today</div><div class="s-val">${todayCnt}</div></div>
        <div class="stat-card"><div class="s-label">Last 7 Days</div><div class="s-val">${last7Cnt}</div></div>
        <div class="stat-card"><div class="s-label">7-Day Avg</div><div class="s-val">${(last7Cnt/7).toFixed(1)}</div></div>
      </div>
      ${cos.length?`
        <div class="section-label">Top Companies</div>
        ${cos.map(([cn,cnt])=>{
          const pct=(cnt/Math.max(1,cos[0][1])*100).toFixed(1);
          return `<div class="bar-row">
            <div class="bar-label" style="font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${cn}</div>
            <div class="bar-track"><div class="bar-fill" style="width:${pct}%">${cnt>0?cnt:""}</div></div>
          </div>`;
        }).join("")}` : ""}
      <div class="section-label" style="margin-top:16px">Recent Leads</div>
      ${userLeads.slice(0,12).map(e=>`
        <div class="feed-item">
          <div class="fi-co">${e.companyName||"â€”"}</div>
          <div class="fi-time">${fmtTime(e.createdAt.toDate())}</div>
        </div>`).join("")||`<div class="empty">No leads yet.</div>`}
    `;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  MODAL / TABS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  statsBtn.addEventListener("click", () => modalBd.classList.add("open"));
  closeModal.addEventListener("click", () => modalBd.classList.remove("open"));
  modalBd.addEventListener("click", e => { if(e.target===modalBd) modalBd.classList.remove("open"); });

  tabBar.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      tabBar.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      document.querySelectorAll(".tab-panel").forEach(p=>p.classList.remove("active"));
      tab.classList.add("active");
      const panel = document.getElementById("panel-"+tab.dataset.tab);
      if (panel) panel.classList.add("active");
    });
  });
</script>
</body>
</html>
