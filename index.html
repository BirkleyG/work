<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lead Drop</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#060d1a;--card:#0d1929;--border:#1a2e50;
  --text:#e8eeff;--muted:#5a7aa8;
  --orange:#ff7a1a;--orange2:#ff5500;--orange-glow:rgba(255,122,26,.28);--orange-light:#ffab5e;
  --blue:#3a8fff;--blue2:#1a5fd4;--blue-glow:rgba(58,143,255,.28);--blue-light:#7fc3ff;
  --gold:#ffc046;
}
*,*::before,*::after{box-sizing:border-box}
body{margin:0;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
body::before{content:"";position:fixed;inset:0;background:radial-gradient(ellipse 80% 60% at 50% -10%,#0d2250 0%,transparent 65%),radial-gradient(ellipse 40% 40% at 80% 80%,#1a1000 0%,transparent 60%);pointer-events:none;z-index:0}

.page{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:28px 20px 60px}

/* HEADER */
.header{text-align:center;margin-bottom:8px}
.header h1{font-family:'Bebas Neue',sans-serif;font-size:clamp(42px,8vw,72px);letter-spacing:4px;margin:0;background:linear-gradient(160deg,#fff 20%,var(--orange-light) 60%,var(--orange) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1;filter:drop-shadow(0 0 24px var(--orange-glow))}
.header .sub{font-size:13px;color:var(--muted);letter-spacing:3px;text-transform:uppercase;margin-top:4px}

/* GOAL TICKER */
.goal-bar{margin-top:14px;display:flex;align-items:center;gap:12px;font-size:13px;color:var(--muted)}
.goal-bar .count{font-family:'Bebas Neue',sans-serif;font-size:32px;color:var(--orange);line-height:1;letter-spacing:1px}
.goal-bar .slash{color:var(--border);font-size:24px}
.goal-bar .goal-num{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--muted);letter-spacing:1px}

/* GLASS */
.glass-section{margin-top:16px;position:relative;display:flex;flex-direction:column;align-items:center;gap:8px}
.glass-stage{width:200px;height:290px;position:relative}
.glass-outer{position:absolute;inset:0;border-radius:28px 28px 40px 40px;border:2px solid rgba(255,255,255,.12);background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.01));overflow:hidden;box-shadow:0 0 0 1px rgba(255,255,255,.04),0 20px 60px rgba(0,0,0,.6),inset 0 0 30px rgba(255,255,255,.02)}
.glass-outer::before{content:"";position:absolute;top:16px;left:18px;width:14px;height:65%;border-radius:999px;background:rgba(255,255,255,.12);filter:blur(1px)}
/* DUAL WATER LAYERS */
.water-prox{position:absolute;left:0;right:0;bottom:0;height:0%;background:linear-gradient(180deg,rgba(100,180,255,.95),rgba(30,90,220,.9));transition:height 900ms cubic-bezier(.2,.9,.2,1)}
.water-prox::after{content:"";position:absolute;left:-20%;right:-20%;top:-10px;height:20px;background:rgba(100,200,255,.25);border-radius:999px;filter:blur(3px)}
.water-reg{position:absolute;left:0;right:0;bottom:0%;height:0%;background:linear-gradient(180deg,rgba(255,155,50,.95),rgba(255,80,0,.88));transition:height 900ms cubic-bezier(.2,.9,.2,1),bottom 900ms cubic-bezier(.2,.9,.2,1)}
.water-reg::after{content:"";position:absolute;left:-20%;right:-20%;top:-12px;height:24px;background:rgba(255,180,80,.3);border-radius:999px;filter:blur(3px)}
.water-glow{position:absolute;left:0;right:0;bottom:0;height:0%;box-shadow:0 0 50px 20px rgba(255,100,0,.2);transition:height 900ms cubic-bezier(.2,.9,.2,1);pointer-events:none;border-radius:0 0 40px 40px}
.goal-line{position:absolute;left:8px;right:8px;border-top:2px dashed rgba(255,255,255,.18);pointer-events:none}
.splash-canvas{position:absolute;inset:0;width:200px;height:290px;pointer-events:none;z-index:10;overflow:visible}
.pct-label{position:absolute;bottom:10px;width:100%;text-align:center;font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:1px;color:rgba(255,255,255,.9);text-shadow:0 2px 8px rgba(0,0,0,.6);pointer-events:none;z-index:5}
/* Glass legend */
.glass-legend{display:flex;gap:14px;font-size:11px;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
.legend-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:5px;vertical-align:middle}

/* COMPANY SELECTOR */
.company-row{margin-top:16px;width:min(420px,100%);display:flex;gap:8px;align-items:center}
.company-select{flex:1;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0a1626;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;cursor:pointer;transition:border-color 150ms}
.company-select:focus{border-color:var(--orange)}
.co-add-btn{width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:#0a1626;color:var(--muted);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 150ms;flex-shrink:0;line-height:1}
.co-add-btn:hover{border-color:var(--orange);color:var(--orange)}
.co-add-row{display:none;width:min(420px,100%);gap:8px;margin-top:6px}
.co-add-row.open{display:flex}
.co-add-input{flex:1;padding:10px 12px;border-radius:12px;border:1px solid var(--orange);background:#0a1626;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none}
.co-save-btn{padding:10px 16px;border-radius:12px;border:none;background:linear-gradient(160deg,var(--orange),var(--orange2));color:#fff;font-weight:700;font-size:13px;cursor:pointer}
.co-cancel-btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:13px;cursor:pointer}

/* TOGGLES ROW */
.toggles-row{margin-top:12px;display:flex;gap:20px;align-items:center}
.toggle-group{display:flex;align-items:center;gap:8px}
.toggle-label{font-size:12px;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
.toggle-wrap{position:relative;width:48px;height:26px;cursor:pointer}
.toggle-wrap input{opacity:0;width:0;height:0}
.toggle-track{position:absolute;inset:0;border-radius:999px;background:var(--border);border:1px solid #2a4070;transition:background 250ms,box-shadow 250ms}
.toggle-thumb{position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:var(--muted);transition:transform 250ms cubic-bezier(.34,1.56,.64,1),background 250ms}
.toggle-wrap input:checked~.toggle-track{background:var(--orange);box-shadow:0 0 14px var(--orange-glow)}
.toggle-wrap input:checked~.toggle-thumb{transform:translateX(22px);background:#fff}
#proximityToggle:checked~.toggle-track{background:var(--blue);box-shadow:0 0 14px var(--blue-glow)}

/* USER BUTTONS */
.btn-grid{margin-top:16px;display:grid;grid-template-columns:1fr 1fr;gap:12px;width:min(420px,100%)}
.user-btn{position:relative;overflow:hidden;padding:16px 12px;border-radius:16px;border:1.5px solid var(--border);background:linear-gradient(160deg,#0e1e38,#091428);color:var(--text);cursor:pointer;transition:transform 80ms,border-color 250ms,box-shadow 250ms,background 250ms;display:flex;flex-direction:column;align-items:center;gap:3px}
.user-btn .plus{font-family:'Bebas Neue',sans-serif;font-size:26px;line-height:1;color:var(--orange);transition:color 200ms}
.user-btn .name{font-size:13px;letter-spacing:1px;color:var(--muted);font-weight:600}
.user-btn .today{font-size:20px;font-weight:800;color:#fff}
.user-btn:hover{border-color:var(--orange);box-shadow:0 0 20px var(--orange-glow),inset 0 0 20px rgba(255,122,26,.04);transform:translateY(-1px)}
.user-btn:active{transform:scale(.97)}
.user-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.user-btn.mode-batch{border-color:var(--orange);background:linear-gradient(160deg,#1e1205,#140d03);box-shadow:0 0 22px var(--orange-glow),inset 0 0 30px rgba(255,122,26,.06)}
.user-btn.mode-batch .plus{color:var(--orange-light)}
.user-btn.mode-prox{border-color:var(--blue);background:linear-gradient(160deg,#051830,#020e22);box-shadow:0 0 22px var(--blue-glow),inset 0 0 30px rgba(58,143,255,.06)}
.user-btn.mode-prox .plus{color:var(--blue-light)}
.user-btn.mode-prox .name{color:var(--blue)}
.user-btn.mode-prox:hover{border-color:var(--blue);box-shadow:0 0 22px var(--blue-glow)}
/* batch overrides prox */
.user-btn.mode-batch.mode-prox{border-color:var(--orange);background:linear-gradient(160deg,#1e1205,#140d03);box-shadow:0 0 22px var(--orange-glow)}
.user-btn.mode-batch.mode-prox .plus{color:var(--orange-light)}
.user-btn.mode-batch.mode-prox .name{color:var(--orange)}
.user-btn .ripple-circle{position:absolute;border-radius:50%;background:rgba(255,122,26,.25);transform:scale(0);animation:btn-ripple 500ms ease-out forwards;pointer-events:none}
@keyframes btn-ripple{to{transform:scale(4);opacity:0}}
.user-btn::after{content:"";position:absolute;inset:0;background:radial-gradient(circle at center,rgba(255,122,26,.18),transparent 70%);opacity:0;transition:opacity .15s;border-radius:16px}
.user-btn.flash::after{opacity:1}

/* BOTTOM ROW */
.bottom-row{margin-top:22px;display:flex;gap:12px;align-items:center}
.stats-btn{padding:13px 30px;border-radius:999px;border:1.5px solid var(--border);background:linear-gradient(160deg,#0e1e38,#091428);color:var(--muted);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 200ms}
.stats-btn:hover{border-color:var(--orange);color:var(--orange-light);box-shadow:0 0 20px var(--orange-glow)}
.admin-btn{padding:13px 20px;border-radius:999px;border:1.5px solid var(--border);background:transparent;color:var(--muted);font-size:13px;font-weight:600;cursor:pointer;transition:all 200ms;letter-spacing:1px}
.admin-btn:hover{border-color:#e94444;color:#e94444;box-shadow:0 0 16px rgba(233,68,68,.2)}

/* TOAST */
.toast{position:fixed;top:16px;left:50%;transform:translateX(-50%);background:#0e1929;border:1px solid var(--orange);padding:10px 18px;border-radius:12px;font-size:13px;color:var(--orange-light);box-shadow:0 0 20px var(--orange-glow);opacity:0;transition:opacity .2s;pointer-events:none;z-index:9999;white-space:nowrap}
.toast.show{opacity:1}

/* BATCH DIALOG */
.batch-overlay{position:fixed;inset:0;background:rgba(4,9,20,.7);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:2000}
.batch-overlay.open{display:flex}
.batch-dialog{background:linear-gradient(160deg,#0e1e38,#091428);border:1.5px solid var(--orange);border-radius:20px;padding:28px 24px;min-width:280px;text-align:center;box-shadow:0 0 40px var(--orange-glow),0 20px 60px rgba(0,0,0,.6);animation:pop-in 200ms cubic-bezier(.34,1.56,.64,1)}
@keyframes pop-in{from{transform:scale(.85);opacity:0}to{transform:scale(1);opacity:1}}
.bd-title{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px;color:var(--orange-light);margin-bottom:6px}
.bd-sub{font-size:13px;color:var(--muted);margin-bottom:18px}
.batch-num-input{width:100%;padding:14px;background:#060d1a;border:1.5px solid var(--border);border-radius:12px;color:#fff;font-family:'Bebas Neue',sans-serif;font-size:36px;text-align:center;outline:none;transition:border-color 150ms}
.batch-num-input:focus{border-color:var(--orange)}
.batch-btns{display:flex;gap:10px;margin-top:16px}
.batch-confirm{flex:1;padding:13px;border-radius:12px;border:none;background:linear-gradient(160deg,#ff7a1a,#c44400);color:#fff;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:opacity 150ms}
.batch-confirm:hover{opacity:.9}
.batch-cancel{padding:13px 18px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:14px;cursor:pointer;transition:border-color 150ms}
.batch-cancel:hover{border-color:var(--orange);color:var(--orange-light)}

/* GOAL CELEBRATION */
#celebrationCanvas{position:fixed;inset:0;z-index:5000;pointer-events:none;display:none}
.celebration-overlay{position:fixed;inset:0;z-index:5001;display:none;flex-direction:column;align-items:center;justify-content:center;pointer-events:none}
.celebration-overlay.show{display:flex}
.celeb-card{background:linear-gradient(160deg,#0e1e38,#091428);border:2px solid var(--gold);border-radius:28px;padding:40px 50px;text-align:center;box-shadow:0 0 60px rgba(255,192,70,.35),0 0 120px rgba(255,122,26,.2),0 30px 80px rgba(0,0,0,.7);animation:celeb-pop 600ms cubic-bezier(.34,1.56,.64,1);pointer-events:all;cursor:pointer}
@keyframes celeb-pop{from{transform:scale(.5) rotate(-5deg);opacity:0}to{transform:scale(1) rotate(0);opacity:1}}
.celeb-title{font-family:'Bebas Neue',sans-serif;font-size:clamp(52px,12vw,96px);letter-spacing:6px;background:linear-gradient(160deg,#fff 10%,var(--gold) 50%,var(--orange) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1;filter:drop-shadow(0 0 30px rgba(255,192,70,.5))}
.celeb-sub{font-size:18px;color:var(--muted);letter-spacing:3px;text-transform:uppercase;margin-top:8px}
.celeb-dismiss{font-size:12px;color:var(--muted);margin-top:16px;letter-spacing:2px;text-transform:uppercase}

/* STATS MODAL */
.modal-backdrop{position:fixed;inset:0;background:rgba(4,9,20,.85);backdrop-filter:blur(6px);display:none;align-items:flex-end;justify-content:center;z-index:1000;padding:0}
.modal-backdrop.open{display:flex}
.modal{width:min(820px,100%);max-height:88vh;background:linear-gradient(180deg,#0e1a2e,#091220);border:1px solid var(--border);border-radius:24px 24px 0 0;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 -20px 60px rgba(0,0,0,.7);animation:slide-up 300ms cubic-bezier(.2,.9,.2,1)}
@keyframes slide-up{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:40px;height:4px;background:var(--border);border-radius:999px;margin:12px auto 0;flex-shrink:0}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 20px 0;flex-shrink:0}
.modal-title{font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:2px}
.close-btn{width:32px;height:32px;border-radius:50%;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 150ms;line-height:1}
.close-btn:hover{border-color:var(--orange);color:var(--orange)}
.tabs{display:flex;gap:4px;padding:12px 20px 0;overflow-x:auto;flex-shrink:0;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{padding:8px 16px;border-radius:10px;border:1px solid transparent;background:transparent;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;transition:all 150ms}
.tab:hover{color:var(--text)}
.tab.active{background:#0e1e38;border-color:var(--border);color:var(--orange-light)}
.tab-content{flex:1;overflow-y:auto;padding:16px 20px 24px}
.tab-panel{display:none}
.tab-panel.active{display:block}
.tab-content::-webkit-scrollbar{width:4px}
.tab-content::-webkit-scrollbar-thumb{background:var(--border);border-radius:999px}

/* LEADERBOARD */
.lb-compare{display:flex;flex-direction:column;gap:14px;margin-bottom:20px}
.lb-row{background:#0a1626;border:1px solid var(--border);border-radius:14px;padding:14px 16px;display:flex;align-items:center;gap:14px;position:relative;overflow:hidden}
.lb-row:nth-child(1){border-color:rgba(255,192,70,.4)}
.lb-row:nth-child(2){border-color:rgba(192,192,192,.3)}
.lb-row:nth-child(3){border-color:rgba(205,127,50,.3)}
.lb-row .rank-badge{font-family:'Bebas Neue',sans-serif;font-size:26px;line-height:1;width:30px;flex-shrink:0;text-align:center}
.lb-row:nth-child(1) .rank-badge{color:var(--gold)}
.lb-row:nth-child(2) .rank-badge{color:#c0c0c0}
.lb-row:nth-child(3) .rank-badge{color:#cd7f32}
.lb-row:nth-child(4) .rank-badge{color:var(--muted)}
.lb-row .lb-name{font-weight:700;font-size:15px;width:80px;flex-shrink:0}
.lb-row .lb-bars{flex:1;display:flex;flex-direction:column;gap:5px}
.mini-bar-row{display:flex;align-items:center;gap:6px}
.mini-bar-label{font-size:10px;color:var(--muted);letter-spacing:1px;width:36px;flex-shrink:0}
.mini-bar-track{flex:1;height:16px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.05);border-radius:4px;overflow:hidden}
.mini-bar-fill{height:100%;background:linear-gradient(90deg,var(--orange2),var(--orange));border-radius:4px;display:flex;align-items:center;justify-content:flex-end;padding-right:6px;font-size:10px;font-weight:700;color:rgba(255,255,255,.9);min-width:2px;transition:width 700ms cubic-bezier(.2,.9,.2,1)}
.mini-bar-fill.bar-today{background:linear-gradient(90deg,#1a6e3a,#2ade80)}
.mini-bar-fill.bar-avg{background:linear-gradient(90deg,#1a3e8e,#5aabff)}
.mini-bar-fill.bar-prox{background:linear-gradient(90deg,#1a3e8e,#3a8fff)}
.lb-row .lb-nums{display:flex;flex-direction:column;align-items:flex-end;gap:2px;flex-shrink:0}
.lb-num-big{font-family:'Bebas Neue',sans-serif;font-size:28px;color:var(--orange);line-height:1;letter-spacing:1px}
.lb-avg-val{font-family:'Bebas Neue',sans-serif;font-size:16px;color:#5aabff;letter-spacing:1px}

.section-label{font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin:14px 0 10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:18px}
.stat-card{background:#0a1626;border:1px solid var(--border);border-radius:14px;padding:14px 12px}
.stat-card .s-label{font-size:11px;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
.stat-card .s-val{font-family:'Bebas Neue',sans-serif;font-size:32px;color:var(--orange-light);letter-spacing:1px;line-height:1.1;margin-top:4px}
.stat-card .s-val.blue{color:var(--blue-light)}
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.bar-label{font-size:13px;color:var(--muted);width:80px;flex-shrink:0}
.bar-track{flex:1;height:22px;background:#0a1626;border:1px solid var(--border);border-radius:6px;overflow:hidden}
.bar-fill{height:100%;background:linear-gradient(90deg,var(--orange2),var(--orange));border-radius:6px;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;font-size:11px;font-weight:700;color:rgba(255,255,255,.9);min-width:2px;transition:width 600ms cubic-bezier(.2,.9,.2,1)}
.bar-fill.blue{background:linear-gradient(90deg,#1a3e8e,#3a8fff)}
/* proximity split bar */
.prox-split-track{flex:1;height:22px;border:1px solid var(--border);border-radius:6px;overflow:hidden;display:flex}
.prox-split-prox{height:100%;background:linear-gradient(90deg,#1a3e8e,#3a8fff);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:rgba(255,255,255,.9);transition:width 600ms;min-width:0}
.prox-split-reg{height:100%;background:linear-gradient(90deg,var(--orange2),var(--orange));display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:rgba(255,255,255,.9);transition:width 600ms;min-width:0}

.feed-item{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid rgba(26,46,80,.4);font-size:13px}
.feed-item:last-child{border-bottom:none}
.fi-name{color:var(--text);font-weight:600}
.fi-co{color:var(--muted)}
.fi-time{font-size:11px;color:var(--muted)}
.fi-badge{font-size:10px;padding:2px 7px;border-radius:999px;border:1px solid var(--blue);color:var(--blue-light);margin-left:6px}
.empty{color:var(--muted);font-size:13px;padding:12px 0}

/* ADMIN MODAL */
.admin-modal-wrap{position:fixed;inset:0;background:rgba(4,9,20,.9);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:3000;padding:20px}
.admin-modal-wrap.open{display:flex}
.admin-modal{width:min(600px,100%);max-height:90vh;background:linear-gradient(180deg,#0e1a2e,#091220);border:1px solid #e94444;border-radius:20px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 0 40px rgba(233,68,68,.2),0 20px 60px rgba(0,0,0,.7);animation:pop-in 250ms cubic-bezier(.34,1.56,.64,1)}
.admin-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border);flex-shrink:0}
.admin-title{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:2px;color:#e94444}
.admin-body{flex:1;overflow-y:auto;padding:20px}
.admin-body::-webkit-scrollbar{width:4px}
.admin-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:999px}
/* Password screen */
.admin-pw-screen{display:flex;flex-direction:column;gap:14px;align-items:center;padding:10px 0}
.admin-pw-screen p{color:var(--muted);font-size:13px;text-align:center;margin:0}
.admin-pw-input{width:100%;padding:14px;background:#060d1a;border:1.5px solid var(--border);border-radius:12px;color:#fff;font-family:'DM Sans',sans-serif;font-size:16px;text-align:center;letter-spacing:4px;outline:none;transition:border-color 150ms}
.admin-pw-input:focus{border-color:#e94444}
.admin-pw-btn{padding:13px 30px;border-radius:12px;border:none;background:linear-gradient(160deg,#e94444,#a42020);color:#fff;font-weight:700;font-size:15px;cursor:pointer;transition:opacity 150ms}
.admin-pw-btn:hover{opacity:.9}
.admin-pw-error{color:#e94444;font-size:13px;display:none}
.admin-pw-error.show{display:block}
/* Admin sections */
.admin-section{background:#0a1626;border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:14px}
.admin-section-title{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:1px;color:#e94444;margin-bottom:12px}
.admin-row{display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
.admin-row:last-child{margin-bottom:0}
.admin-label{font-size:13px;color:var(--muted);width:80px;flex-shrink:0}
.admin-input{flex:1;min-width:80px;padding:9px 12px;background:#060d1a;border:1px solid var(--border);border-radius:10px;color:#fff;font-size:14px;outline:none;text-align:center;transition:border-color 150ms}
.admin-input:focus{border-color:#e94444}
.admin-action-btn{padding:9px 16px;border-radius:10px;border:none;font-size:13px;font-weight:600;cursor:pointer;transition:opacity 150ms;white-space:nowrap}
.admin-action-btn:hover{opacity:.85}
.btn-red{background:linear-gradient(160deg,#e94444,#a42020);color:#fff}
.btn-yellow{background:linear-gradient(160deg,#e6a020,#9a6000);color:#fff}
.admin-divider{height:1px;background:var(--border);margin:10px 0}
.admin-confirm-bar{background:rgba(233,68,68,.1);border:1px solid rgba(233,68,68,.3);border-radius:10px;padding:12px;display:none;gap:10px;align-items:center;flex-wrap:wrap;font-size:13px;color:#e98888;margin-top:8px}
.admin-confirm-bar.show{display:flex}
</style>
</head>
<body>
<div class="toast" id="toast"></div>

<!-- Batch Dialog -->
<div class="batch-overlay" id="batchOverlay">
  <div class="batch-dialog">
    <div class="bd-title" id="bdTitle">Add Leads</div>
    <div class="bd-sub" id="bdSub">How many leads to add?</div>
    <input class="batch-num-input" id="batchNumInput" type="number" min="1" max="999" value="1"/>
    <div class="batch-btns">
      <button class="batch-cancel" id="batchCancel">Cancel</button>
      <button class="batch-confirm" id="batchConfirm">Add Leads</button>
    </div>
  </div>
</div>

<!-- Goal Celebration -->
<canvas id="celebrationCanvas"></canvas>
<div class="celebration-overlay" id="celebrationOverlay">
  <div class="celeb-card" id="celebCard">
    <div class="celeb-title">GOAL MET!</div>
    <div class="celeb-sub">Congratulations Team üéâ</div>
    <div class="celeb-dismiss">Tap anywhere to dismiss</div>
  </div>
</div>

<!-- MAIN PAGE -->
<div class="page">
  <div class="header">
    <h1>Lead Drop</h1>
    <div class="sub">Every lead fills the glass</div>
  </div>

  <div class="goal-bar">
    <span class="count" id="totalCount">0</span>
    <span class="slash"> /</span>
    <span class="goal-num" id="goalNum">‚Äî</span>
    <span style="font-size:12px">ALL-TIME LEADS</span>
  </div>

  <!-- Glass -->
  <div class="glass-section">
    <div class="glass-stage" id="glassStage">
      <div class="glass-outer">
        <div class="water-prox" id="waterProx"></div>
        <div class="water-reg" id="waterReg"></div>
        <div class="water-glow" id="waterGlow"></div>
        <div class="goal-line" style="top:6%"></div>
      </div>
      <canvas class="splash-canvas" id="splashCanvas" width="200" height="290"></canvas>
      <div class="pct-label" id="pctLabel">0%</div>
    </div>
    <div class="glass-legend">
      <span><span class="legend-dot" style="background:#3a8fff"></span>Close</span>
      <span><span class="legend-dot" style="background:#ff7a1a"></span>Far</span>
    </div>
  </div>

  <!-- Company selector -->
  <div class="company-row">
    <select class="company-select" id="companySelect">
      <option value="">No company selected</option>
    </select>
    <button class="co-add-btn" id="coAddBtn" title="Add new company">+</button>
  </div>
  <div class="co-add-row" id="coAddRow">
    <input class="co-add-input" id="coAddInput" placeholder="Company name‚Ä¶" />
    <button class="co-save-btn" id="coSaveBtn">Save</button>
    <button class="co-cancel-btn" id="coCancelBtn">‚úï</button>
  </div>

  <!-- Toggles -->
  <div class="toggles-row">
    <div class="toggle-group">
      <span class="toggle-label">Batch</span>
      <label class="toggle-wrap">
        <input type="checkbox" id="batchToggle"/>
        <div class="toggle-track"></div>
        <div class="toggle-thumb"></div>
      </label>
    </div>
    <div class="toggle-group">
      <span class="toggle-label">Proximity</span>
      <label class="toggle-wrap">
        <input type="checkbox" id="proximityToggle"/>
        <div class="toggle-track"></div>
        <div class="toggle-thumb"></div>
      </label>
    </div>
  </div>

  <!-- User buttons -->
  <div class="btn-grid">
    <button class="user-btn" id="btn-Alston" disabled>
      <span class="plus">+1</span>
      <span class="today" id="today-Alston">0</span>
      <span class="name">ALSTON</span>
    </button>
    <button class="user-btn" id="btn-Jennifer" disabled>
      <span class="plus">+1</span>
      <span class="today" id="today-Jennifer">0</span>
      <span class="name">JENNIFER</span>
    </button>
    <button class="user-btn" id="btn-Lina" disabled>
      <span class="plus">+1</span>
      <span class="today" id="today-Lina">0</span>
      <span class="name">LINA</span>
    </button>
    <button class="user-btn" id="btn-Ziyu" disabled>
      <span class="plus">+1</span>
      <span class="today" id="today-Ziyu">0</span>
      <span class="name">ZIYU</span>
    </button>
  </div>

  <div class="bottom-row">
    <button class="stats-btn" id="statsBtn">üìä View Stats</button>
    <button class="admin-btn" id="adminBtn">‚öô Admin</button>
  </div>
</div>

<!-- STATS MODAL -->
<div class="modal-backdrop" id="statsModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title">Performance Stats</div>
      <button class="close-btn" id="closeStats">‚úï</button>
    </div>
    <div class="tabs" id="tabBar">
      <button class="tab active" data-tab="leaderboard">Leaderboard</button>
      <button class="tab" data-tab="general">General</button>
      <button class="tab" data-tab="Alston">Alston</button>
      <button class="tab" data-tab="Jennifer">Jennifer</button>
      <button class="tab" data-tab="Lina">Lina</button>
      <button class="tab" data-tab="Ziyu">Ziyu</button>
    </div>
    <div class="tab-content">
      <div class="tab-panel active" id="panel-leaderboard">
        <div class="section-label">Today ‚Äî Head to Head</div>
        <div class="lb-compare" id="lb-today"></div>
        <div class="section-label" style="margin-top:20px">All-Time ‚Äî Head to Head</div>
        <div class="lb-compare" id="lb-all"></div>
      </div>
      <div class="tab-panel" id="panel-general">
        <div class="stat-grid" id="general-stats"></div>
        <div class="section-label">Proximity Breakdown</div>
        <div id="prox-breakdown"></div>
        <div class="section-label" style="margin-top:16px">Last 7 Days by Person</div>
        <div id="trends-bars"></div>
        <div class="section-label" style="margin-top:20px">Recent Activity</div>
        <div id="recent-feed"></div>
      </div>
      <div class="tab-panel" id="panel-Alston"><div id="up-Alston"></div></div>
      <div class="tab-panel" id="panel-Jennifer"><div id="up-Jennifer"></div></div>
      <div class="tab-panel" id="panel-Lina"><div id="up-Lina"></div></div>
      <div class="tab-panel" id="panel-Ziyu"><div id="up-Ziyu"></div></div>
    </div>
  </div>
</div>

<!-- ADMIN MODAL -->
<div class="admin-modal-wrap" id="adminModal">
  <div class="admin-modal">
    <div class="admin-header">
      <div class="admin-title">‚öô Admin Panel</div>
      <button class="close-btn" id="closeAdmin" style="border-color:#e9444455;color:#e94444">‚úï</button>
    </div>
    <div class="admin-body" id="adminBody">
      <!-- Password screen shown first -->
      <div class="admin-pw-screen" id="adminPwScreen">
        <p>Enter admin password to continue</p>
        <input class="admin-pw-input" id="adminPwInput" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="100"/>
        <div class="admin-pw-error" id="adminPwError">Incorrect password</div>
        <button class="admin-pw-btn" id="adminPwBtn">Unlock</button>
      </div>
      <!-- Admin dashboard (hidden until unlocked) -->
      <div id="adminDash" style="display:none">
        <!-- Set Analyst Count -->
        <div class="admin-section">
          <div class="admin-section-title">Set Analyst Lead Count</div>
          <div id="adminCountRows"></div>
          <div class="admin-divider"></div>
          <div style="font-size:12px;color:var(--muted)">Sets the all-time total for that analyst by adding or removing leads.</div>
        </div>
        <!-- Batch Delete -->
        <div class="admin-section">
          <div class="admin-section-title">Delete Leads</div>
          <div class="admin-row">
            <span class="admin-label">By Person</span>
            <select class="admin-input" id="adminDeleteUser" style="flex:1">
              <option value="">All analysts</option>
              <option>Alston</option><option>Jennifer</option><option>Lina</option><option>Ziyu</option>
            </select>
            <button class="admin-action-btn btn-red" id="adminDeleteBtn">Delete</button>
          </div>
          <div class="admin-confirm-bar" id="adminDeleteConfirm">
            <span id="adminDeleteMsg"></span>
            <button class="admin-action-btn btn-red" id="adminDeleteConfirmBtn" style="margin-left:auto">Confirm Delete</button>
            <button class="admin-action-btn" style="background:var(--border);color:var(--text)" id="adminDeleteCancelBtn">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore,collection,doc,getDoc,setDoc,addDoc,getDocs,deleteDoc,
  query,where,orderBy,limit,onSnapshot,serverTimestamp,writeBatch
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import {
  getAuth,signInAnonymously,onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FIREBASE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const firebaseConfig = {
  apiKey:"AIzaSyD_lk0-JE861RqFt9dZR1YMRl-qr_9xHtU",
  authDomain:"lead-tracker-c13ca.firebaseapp.com",
  projectId:"lead-tracker-c13ca",
  storageBucket:"lead-tracker-c13ca.firebasestorage.app",
  messagingSenderId:"590497117694",
  appId:"1:590497117694:web:dc071c3b8506273667fcaf",
  measurementId:"G-Q3NW44KW1K"
};
const TEAM = ["Alston","Jennifer","Lina","Ziyu"];
let GOAL = 100;
let ADMIN_PW = "";

const app  = initializeApp(firebaseConfig);
const db   = getFirestore(app);
const auth = getAuth(app);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DOM REFS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const $  = id => document.getElementById(id);
const waterProxEl    = $("waterProx");
const waterRegEl     = $("waterReg");
const waterGlowEl    = $("waterGlow");
const splashCanvas   = $("splashCanvas");
const ctx            = splashCanvas.getContext("2d");
const pctLabel       = $("pctLabel");
const totalCountEl   = $("totalCount");
const goalNumEl      = $("goalNum");
const toastEl        = $("toast");
const companySelect  = $("companySelect");
const coAddBtn       = $("coAddBtn");
const coAddRow       = $("coAddRow");
const coAddInput     = $("coAddInput");
const coSaveBtn      = $("coSaveBtn");
const coCancelBtn    = $("coCancelBtn");
const batchToggle    = $("batchToggle");
const proximityToggle= $("proximityToggle");
const batchOverlay   = $("batchOverlay");
const batchNumInput  = $("batchNumInput");
const batchConfirm   = $("batchConfirm");
const batchCancel    = $("batchCancel");
const bdTitle        = $("bdTitle");
const bdSub          = $("bdSub");
const statsBtn       = $("statsBtn");
const statsModal     = $("statsModal");
const closeStats     = $("closeStats");
const tabBar         = $("tabBar");
const adminBtn       = $("adminBtn");
const adminModal     = $("adminModal");
const closeAdmin     = $("closeAdmin");
const adminPwScreen  = $("adminPwScreen");
const adminPwInput   = $("adminPwInput");
const adminPwBtn     = $("adminPwBtn");
const adminPwError   = $("adminPwError");
const adminDash      = $("adminDash");
const celebCanvas    = $("celebrationCanvas");
const celebOverlay   = $("celebrationOverlay");

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let uid = null;
let allLeads = [];
let companies = [];
let batchMode = false;
let proximityMode = false;
let pendingBatchUser = null;
let goalCelebrated = false;
let prevTotal = 0;
let listenersStarted = false;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toast(msg,err=false){
  toastEl.textContent=msg;
  toastEl.style.borderColor=err?"rgba(233,68,68,.7)":"rgba(255,122,26,.55)";
  toastEl.classList.add("show");
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>toastEl.classList.remove("show"),2400);
}
function startOfToday(){const d=new Date();d.setHours(0,0,0,0);return d;}
function startOf7DaysAgo(){return new Date(Date.now()-7*864e5);}
function fmtTime(d){
  const s=(Date.now()-d)/1000;
  if(s<60)return "just now";
  if(s<3600)return Math.floor(s/60)+"m ago";
  if(s<86400)return Math.floor(s/3600)+"h ago";
  return d.toLocaleDateString("en-US",{month:"short",day:"numeric"});
}
function tally(arr,fn){
  const m=new Map();
  arr.forEach(e=>{const k=fn(e);m.set(k,(m.get(k)||0)+1);});
  return [...m.entries()].sort((a,b)=>b[1]-a[1]);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   WATER FILL ‚Äî DUAL COLOR
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let currentFillPct = 0;
function setFill(total, proxCount){
  const totalPct = GOAL>0 ? Math.min(100,(total/GOAL)*100) : 0;
  const proxPct  = GOAL>0 ? Math.min(totalPct,(proxCount/GOAL)*100) : 0;
  const regPct   = Math.max(0, totalPct - proxPct);

  currentFillPct = totalPct;
  waterProxEl.style.height  = proxPct+"%";
  waterRegEl.style.height   = regPct+"%";
  waterRegEl.style.bottom   = proxPct+"%";
  waterGlowEl.style.height  = totalPct+"%";
  pctLabel.textContent      = Math.round(totalPct)+"%";
  totalCountEl.textContent  = total;

  // Goal celebration
  if(total >= GOAL && !goalCelebrated && prevTotal < GOAL && total > 0){
    goalCelebrated = true;
    launchCelebration();
  }
  prevTotal = total;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SPLASH ANIMATION (canvas)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const CW=200,CH=290;
let animFrame=null,particles=[],ripples=[],dropPhase=null,impactDone=false;

function getWaterY(){ return CH-(currentFillPct/100)*CH; }

function launchSplash(){
  const surfY = getWaterY();
  const cx = CW/2;
  dropPhase = {y:-14,vy:3};
  impactDone = false;

  // particles (scheduled on impact)
  for(let i=0;i<32;i++){
    const ang = Math.PI*(0.1+0.8*Math.random())+Math.PI;
    const spd = 3+Math.random()*8;
    particles.push({x:cx,y:surfY,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,grav:0.28+Math.random()*.12,alpha:0.9+Math.random()*.1,size:2.5+Math.random()*5,born:false});
  }
  for(let i=0;i<7;i++){
    const ang = Math.PI*(0.05+0.9*(i/6))+Math.PI;
    particles.push({x:cx,y:surfY,vx:Math.cos(ang)*(5+i*1.4),vy:-9-Math.random()*6,grav:0.22,alpha:1,size:5+Math.random()*4,born:false});
  }
  ripples=[
    {y:surfY,r:0,maxR:80,alpha:.75,spd:2.8,born:false},
    {y:surfY,r:0,maxR:55,alpha:.5,spd:2.0,born:false},
    {y:surfY,r:0,maxR:35,alpha:.35,spd:1.3,born:false},
  ];
  if(!animFrame) animLoop();
}

function triggerImpact(){
  particles.forEach(p=>p.born=true);
  ripples.forEach(r=>r.born=true);
  impactDone=true; dropPhase=null;
}

function animLoop(){
  ctx.clearRect(0,0,CW,CH);
  let live=false;

  // falling drop
  if(dropPhase){
    dropPhase.vy+=0.48; dropPhase.y+=dropPhase.vy;
    const {y}=dropPhase, x=CW/2;
    // teardrop path
    const grd=ctx.createLinearGradient(x-10,y-16,x+10,y+10);
    grd.addColorStop(0,"rgba(255,220,140,.95)");
    grd.addColorStop(1,"rgba(255,70,0,.95)");
    ctx.save();
    ctx.shadowColor="rgba(255,120,0,.6)"; ctx.shadowBlur=12;
    ctx.fillStyle=grd;
    ctx.beginPath();
    ctx.moveTo(x,y-16);
    ctx.bezierCurveTo(x+11,y-4,x+11,y+6,x,y+10);
    ctx.bezierCurveTo(x-11,y+6,x-11,y-4,x,y-16);
    ctx.fill(); ctx.restore();
    const surfY=getWaterY();
    if(dropPhase.y+10>=surfY && !impactDone) triggerImpact();
    live=true;
  }

  // ripples
  ripples.forEach(r=>{
    if(!r.born){live=true;return;}
    r.r+=r.spd; r.alpha*=0.965;
    if(r.r<r.maxR&&r.alpha>0.02){
      ctx.save();
      ctx.translate(CW/2,r.y);
      ctx.scale(1,0.3);
      ctx.strokeStyle=`rgba(255,160,60,${r.alpha})`;
      ctx.lineWidth=2;
      ctx.beginPath(); ctx.arc(0,0,r.r,0,Math.PI*2); ctx.stroke();
      ctx.restore(); live=true;
    }
  });

  // particles
  particles=particles.filter(p=>{
    if(!p.born){live=true;return true;}
    p.vy+=p.grav; p.x+=p.vx; p.y+=p.vy; p.alpha*=0.968; p.vx*=0.993;
    if(p.alpha<0.03||p.y>CH+30) return false;
    const grd=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.size);
    grd.addColorStop(0,`rgba(255,200,80,${p.alpha})`);
    grd.addColorStop(1,`rgba(255,70,0,${p.alpha*.4})`);
    ctx.save(); ctx.shadowColor=`rgba(255,130,0,${p.alpha*.5})`; ctx.shadowBlur=6;
    ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill(); ctx.restore();
    live=true; return true;
  });

  if(live){ animFrame=requestAnimationFrame(animLoop); }
  else{ ctx.clearRect(0,0,CW,CH); animFrame=null; }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GOAL CELEBRATION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let celebAF=null;
function launchCelebration(){
  const cc=celebCanvas;
  cc.width=window.innerWidth; cc.height=window.innerHeight;
  cc.style.display="block";
  celebOverlay.classList.add("show");

  const ccx=cc.getContext("2d");
  const pieces=[];
  const colors=["#ff7a1a","#ffc046","#3a8fff","#ff5500","#ffab5e","#ffffff","#4ade80","#f472b6"];

  for(let i=0;i<220;i++){
    const cx=cc.width/2, cy=cc.height/2;
    const angle=Math.random()*Math.PI*2;
    const spd=8+Math.random()*18;
    pieces.push({
      x:cx,y:cy,
      vx:Math.cos(angle)*spd*(0.5+Math.random()),
      vy:Math.sin(angle)*spd*(0.5+Math.random())-14*Math.random(),
      grav:0.35+Math.random()*.2,
      rot:Math.random()*360,rotV:(Math.random()-0.5)*14,
      w:8+Math.random()*12,h:5+Math.random()*8,
      color:colors[Math.floor(Math.random()*colors.length)],
      alpha:1,shape:Math.floor(Math.random()*3)
    });
  }
  // side burst cannons
  [0,cc.width].forEach(startX=>{
    for(let i=0;i<60;i++){
      const ang=(startX===0?-0.3:Math.PI+0.3)+(Math.random()-0.5)*1.4;
      const spd=10+Math.random()*16;
      pieces.push({
        x:startX,y:cc.height*0.4+Math.random()*cc.height*0.2,
        vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd-5,
        grav:0.3+Math.random()*.15,
        rot:Math.random()*360,rotV:(Math.random()-0.5)*12,
        w:6+Math.random()*10,h:4+Math.random()*7,
        color:colors[Math.floor(Math.random()*colors.length)],
        alpha:1,shape:Math.floor(Math.random()*3)
      });
    }
  });

  function celebFrame(){
    ccx.clearRect(0,0,cc.width,cc.height);
    let any=false;
    pieces.forEach(p=>{
      p.vy+=p.grav; p.x+=p.vx; p.y+=p.vy; p.rot+=p.rotV;
      p.vx*=0.995; p.alpha=Math.max(0,p.alpha-0.007);
      if(p.alpha<=0||p.y>cc.height+40) return;
      ccx.save();
      ccx.globalAlpha=p.alpha;
      ccx.translate(p.x,p.y);
      ccx.rotate(p.rot*Math.PI/180);
      ccx.fillStyle=p.color;
      ccx.shadowColor=p.color; ccx.shadowBlur=4;
      if(p.shape===0){ ccx.fillRect(-p.w/2,-p.h/2,p.w,p.h); }
      else if(p.shape===1){ ccx.beginPath();ccx.arc(0,0,p.w/2,0,Math.PI*2);ccx.fill(); }
      else{ ccx.beginPath();ccx.moveTo(0,-p.h);ccx.lineTo(p.w/2,p.h/2);ccx.lineTo(-p.w/2,p.h/2);ccx.closePath();ccx.fill(); }
      ccx.restore(); any=true;
    });
    if(any){ celebAF=requestAnimationFrame(celebFrame); }
    else{ cc.style.display="none"; }
  }
  celebAF=requestAnimationFrame(celebFrame);
}

function dismissCelebration(){
  celebOverlay.classList.remove("show");
  celebCanvas.style.display="none";
  if(celebAF){ cancelAnimationFrame(celebAF); celebAF=null; }
}
celebOverlay.addEventListener("click",dismissCelebration);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BUTTON RIPPLE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function btnRipple(btn){
  const r=document.createElement("span");
  r.className="ripple-circle";
  const sz=Math.max(btn.offsetWidth,btn.offsetHeight);
  r.style.cssText=`width:${sz}px;height:${sz}px;left:${btn.offsetWidth/2-sz/2}px;top:${btn.offsetHeight/2-sz/2}px`;
  btn.appendChild(r);
  r.addEventListener("animationend",()=>r.remove());
  btn.classList.add("flash");
  setTimeout(()=>btn.classList.remove("flash"),200);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   COMPANY MANAGEMENT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initCompaniesListener(){
  const q=query(collection(db,"companies"),orderBy("name","asc"),limit(500));
  onSnapshot(q,snap=>{
    companies=snap.docs.map(d=>({id:d.id,...d.data()})).filter(c=>c.name);
    renderCompanySelect();
  });
}

function renderCompanySelect(){
  const prev=companySelect.value;
  companySelect.innerHTML=`<option value="">No company selected</option>`;
  companies.forEach(c=>{
    const o=document.createElement("option");
    o.value=c.id; o.textContent=c.name;
    companySelect.appendChild(o);
  });
  if(prev && companies.some(c=>c.id===prev)) companySelect.value=prev;
}

coAddBtn.addEventListener("click",()=>{
  coAddRow.classList.add("open");
  coAddInput.focus();
});
coCancelBtn.addEventListener("click",()=>{ coAddRow.classList.remove("open"); coAddInput.value=""; });
coSaveBtn.addEventListener("click",saveCompany);
coAddInput.addEventListener("keydown",e=>{ if(e.key==="Enter") saveCompany(); if(e.key==="Escape") coCancelBtn.click(); });

async function saveCompany(){
  const name=coAddInput.value.trim().replace(/\s+/g," ");
  if(!name) return toast("Enter a company name.",true);
  const dup=companies.find(c=>c.name.toLowerCase()===name.toLowerCase());
  if(dup){ companySelect.value=dup.id; coAddRow.classList.remove("open"); coAddInput.value=""; toast("Company exists ‚Äî selected it."); return; }
  try{
    const ref=await addDoc(collection(db,"companies"),{name,createdAt:serverTimestamp()});
    coAddInput.value=""; coAddRow.classList.remove("open");
    // wait for snapshot to update, then select it
    setTimeout(()=>{ companySelect.value=ref.id; },400);
    toast("Company added.");
  }catch(e){ toast("Could not add company.",true); console.error(e); }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TOGGLES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateButtonStyles(){
  TEAM.forEach(n=>{
    const b=document.getElementById("btn-"+n);
    if(!b)return;
    b.classList.toggle("mode-batch",batchMode);
    b.classList.toggle("mode-prox",proximityMode);
    const plusEl=b.querySelector(".plus");
    // label
    if(batchMode){ plusEl.textContent="N+"; }
    else { plusEl.textContent="+1"; }
  });
}

batchToggle.addEventListener("change",()=>{ batchMode=batchToggle.checked; updateButtonStyles(); });
proximityToggle.addEventListener("change",()=>{ proximityMode=proximityToggle.checked; updateButtonStyles(); });

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BATCH DIALOG
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
batchCancel.addEventListener("click",()=>{ batchOverlay.classList.remove("open"); pendingBatchUser=null; });
batchNumInput.addEventListener("keydown",e=>{ if(e.key==="Enter") batchConfirm.click(); if(e.key==="Escape") batchCancel.click(); });
batchConfirm.addEventListener("click",async()=>{
  const n=parseInt(batchNumInput.value,10);
  if(!n||n<1||n>999) return toast("Enter a valid number (1‚Äì999).",true);
  batchOverlay.classList.remove("open");
  const name=pendingBatchUser; pendingBatchUser=null;
  await submitLeads(name,n);
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AUTH & BOOT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
onAuthStateChanged(auth,async user=>{
  if(user){
    uid=user.uid;
    enableButtons();
    if(!listenersStarted){ listenersStarted=true; await loadSettings(); initCompaniesListener(); initLeadsListener(); }
  } else {
    try{ await signInAnonymously(auth); }
    catch(e){ toast("Auth error ‚Äî check Firebase.",true); console.error(e); }
  }
});

function enableButtons(){
  TEAM.forEach(n=>{ const b=document.getElementById("btn-"+n); if(b) b.disabled=false; });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SETTINGS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function loadSettings(){
  try{
    const snap=await getDoc(doc(db,"settings","global"));
    if(snap.exists()){
      const d=snap.data();
      if(typeof d.goal==="number") GOAL=d.goal;
      if(typeof d.password==="string") ADMIN_PW=d.password;
    } else {
      await setDoc(doc(db,"settings","global"),{goal:100,password:"admin"});
    }
  }catch(e){ console.warn("Settings error:",e); }
  goalNumEl.textContent=GOAL;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   USER BUTTON CLICKS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
TEAM.forEach(name=>{
  const btn=document.getElementById("btn-"+name);
  if(!btn)return;
  btn.addEventListener("click",()=>{
    if(!uid) return toast("Not signed in yet‚Ä¶");
    if(batchMode){ pendingBatchUser=name; bdTitle.textContent=name; bdSub.textContent="How many leads to add?"; batchNumInput.value="1"; batchOverlay.classList.add("open"); setTimeout(()=>{batchNumInput.focus();batchNumInput.select();},50); }
    else submitLeads(name,1);
  });
});

async function submitLeads(name,count){
  const btn=document.getElementById("btn-"+name);
  if(btn) btn.disabled=true;
  launchSplash();
  if(btn) btnRipple(btn);

  const compId=companySelect.value;
  const compName=companies.find(c=>c.id===compId)?.name||"";
  const proximity=proximityMode;

  try{
    if(count===1){
      await addDoc(collection(db,"leads"),{createdAt:serverTimestamp(),userName:name,companyId:compId,companyName:compName,proximity});
    } else {
      const CHUNK=499;
      for(let off=0;off<count;off+=CHUNK){
        const batch=writeBatch(db);
        const chunk=Math.min(CHUNK,count-off);
        for(let i=0;i<chunk;i++) batch.set(doc(collection(db,"leads")),{createdAt:serverTimestamp(),userName:name,companyId:compId,companyName:compName,proximity});
        await batch.commit();
      }
      toast(`Added ${count} leads for ${name}!`);
    }
  }catch(e){ toast("Could not save lead(s).",true); console.error(e); }
  finally{ setTimeout(()=>{ if(btn) btn.disabled=false; },700); }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LEADS LISTENER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initLeadsListener(){
  const q=query(collection(db,"leads"),orderBy("createdAt","desc"),limit(10000));
  onSnapshot(q,snap=>{
    allLeads=snap.docs.map(d=>({id:d.id,...d.data()})).filter(x=>x.createdAt&&x.createdAt.toDate);
    computeStats();
  },err=>{ console.error(err); toast("Error loading leads.",true); });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   COMPUTE STATS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function computeStats(){
  const today0=startOfToday(), d7=startOf7DaysAgo();
  const todayLeads=allLeads.filter(e=>e.createdAt.toDate()>=today0);
  const last7Leads=allLeads.filter(e=>e.createdAt.toDate()>=d7);
  const proxLeads=allLeads.filter(e=>e.proximity===true);

  setFill(allLeads.length,proxLeads.length);

  TEAM.forEach(n=>{
    const el=document.getElementById("today-"+n);
    if(el) el.textContent=todayLeads.filter(e=>e.userName===n).length;
  });

  renderLeaderboard(todayLeads,allLeads,last7Leads);
  renderGeneral(allLeads,todayLeads,last7Leads);
  TEAM.forEach(n=>renderUserPanel(n,allLeads));
  renderAdminCounts(allLeads);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LEADERBOARD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderLeaderboard(todayLeads,allLeads,last7Leads){
  buildCompareBlock("lb-today",todayLeads,last7Leads);
  buildCompareBlock("lb-all",allLeads,last7Leads);
}
function buildCompareBlock(id,leads,last7){
  const el=document.getElementById(id);
  el.innerHTML="";
  const today0=startOfToday();
  const rows=TEAM.map(name=>{
    const total=leads.filter(e=>e.userName===name).length;
    const l7=last7.filter(e=>e.userName===name).length;
    const tod=leads.filter(e=>e.userName===name&&e.createdAt.toDate()>=today0).length;
    const prox=leads.filter(e=>e.userName===name&&e.proximity===true).length;
    return {name,total,l7,tod,avg:(l7/7),prox};
  }).sort((a,b)=>b.total-a.total);

  const maxT=Math.max(1,...rows.map(r=>r.total));
  const maxTod=Math.max(1,...rows.map(r=>r.tod));
  const maxAvg=Math.max(.1,...rows.map(r=>r.avg));
  const maxProx=Math.max(1,...rows.map(r=>r.prox));

  rows.forEach((r,i)=>{
    const div=document.createElement("div");
    div.className="lb-row";
    div.innerHTML=`
      <div class="rank-badge">${i+1}</div>
      <div class="lb-name">${r.name}</div>
      <div class="lb-bars">
        <div class="mini-bar-row"><div class="mini-bar-label">ALL</div><div class="mini-bar-track"><div class="mini-bar-fill" style="width:${(r.total/maxT*100).toFixed(1)}%">${r.total||""}</div></div></div>
        <div class="mini-bar-row"><div class="mini-bar-label">TODAY</div><div class="mini-bar-track"><div class="mini-bar-fill bar-today" style="width:${(r.tod/maxTod*100).toFixed(1)}%">${r.tod||""}</div></div></div>
        <div class="mini-bar-row"><div class="mini-bar-label">AVG/D</div><div class="mini-bar-track"><div class="mini-bar-fill bar-avg" style="width:${(r.avg/maxAvg*100).toFixed(1)}%">${r.avg.toFixed(1)||""}</div></div></div>
        <div class="mini-bar-row"><div class="mini-bar-label">CLOSE</div><div class="mini-bar-track"><div class="mini-bar-fill bar-prox" style="width:${(r.prox/maxProx*100).toFixed(1)}%">${r.prox||""}</div></div></div>
      </div>
      <div class="lb-nums">
        <div class="lb-num-big">${r.total}</div>
        <div class="lb-avg-val">${r.avg.toFixed(1)}/d</div>
      </div>`;
    el.appendChild(div);
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GENERAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderGeneral(all,today,last7){
  const proxAll=all.filter(e=>e.proximity===true).length;
  const proxToday=today.filter(e=>e.proximity===true).length;
  const byDay=new Map();
  all.forEach(e=>{const d=e.createdAt.toDate().toDateString();byDay.set(d,(byDay.get(d)||0)+1);});
  const best=byDay.size?Math.max(...byDay.values()):0;

  document.getElementById("general-stats").innerHTML=`
    <div class="stat-card"><div class="s-label">Total All-Time</div><div class="s-val">${all.length}</div></div>
    <div class="stat-card"><div class="s-label">Today (Team)</div><div class="s-val">${today.length}</div></div>
    <div class="stat-card"><div class="s-label">7-Day Avg/Day</div><div class="s-val">${(last7.length/7).toFixed(1)}</div></div>
    <div class="stat-card"><div class="s-label">Best Single Day</div><div class="s-val">${best}</div></div>
    <div class="stat-card"><div class="s-label">Close (All-Time)</div><div class="s-val blue">${proxAll}</div></div>
    <div class="stat-card"><div class="s-label">Close (Today)</div><div class="s-val blue">${proxToday}</div></div>`;

  // Proximity breakdown per person
  const pd=document.getElementById("prox-breakdown");
  const maxAll=Math.max(1,...TEAM.map(n=>all.filter(e=>e.userName===n).length));
  pd.innerHTML=TEAM.map(n=>{
    const uAll=all.filter(e=>e.userName===n).length;
    const uProx=all.filter(e=>e.userName===n&&e.proximity===true).length;
    const uReg=uAll-uProx;
    const proxPct=uAll>0?(uProx/uAll*100).toFixed(0):0;
    const regPct=100-proxPct;
    return `<div class="bar-row">
      <div class="bar-label">${n}</div>
      <div class="prox-split-track">
        <div class="prox-split-prox" style="width:${proxPct}%">${uProx>0?uProx:""}</div>
        <div class="prox-split-reg" style="width:${regPct}%">${uReg>0?uReg:""}</div>
      </div>
      <div style="font-size:11px;color:var(--muted);width:46px;text-align:right;flex-shrink:0">${proxPct}% close</div>
    </div>`;
  }).join("");

  // 7-day bars
  const bars=document.getElementById("trends-bars");
  const maxV=Math.max(1,...TEAM.map(n=>last7.filter(e=>e.userName===n).length));
  bars.innerHTML=TEAM.map(n=>{
    const cnt=last7.filter(e=>e.userName===n).length;
    return `<div class="bar-row"><div class="bar-label">${n}</div><div class="bar-track"><div class="bar-fill" style="width:${(cnt/maxV*100).toFixed(1)}%">${cnt||""}</div></div></div>`;
  }).join("");

  // Recent feed
  const feed=document.getElementById("recent-feed");
  const recent=all.slice(0,18);
  feed.innerHTML=recent.length?recent.map(e=>`
    <div class="feed-item">
      <div><span class="fi-name">${e.userName||"?"}</span>
        ${e.companyName?`<span class="fi-co"> ¬∑ ${e.companyName}</span>`:""}
        ${e.proximity?`<span class="fi-badge">CLOSE</span>`:""}
      </div>
      <div class="fi-time">${fmtTime(e.createdAt.toDate())}</div>
    </div>`).join(""):`<div class="empty">No leads yet.</div>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   USER PANELS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderUserPanel(name,all){
  const el=document.getElementById("up-"+name);
  if(!el)return;
  const ul=all.filter(e=>e.userName===name);
  const today0=startOfToday(),d7=startOf7DaysAgo();
  const todCnt=ul.filter(e=>e.createdAt.toDate()>=today0).length;
  const l7Cnt=ul.filter(e=>e.createdAt.toDate()>=d7).length;
  const proxCnt=ul.filter(e=>e.proximity===true).length;
  const proxPct=ul.length>0?Math.round(proxCnt/ul.length*100):0;
  const cos=tally(ul,e=>e.companyName||"No company").slice(0,8);

  el.innerHTML=`
    <div class="stat-grid">
      <div class="stat-card"><div class="s-label">All-Time</div><div class="s-val">${ul.length}</div></div>
      <div class="stat-card"><div class="s-label">Today</div><div class="s-val">${todCnt}</div></div>
      <div class="stat-card"><div class="s-label">Last 7 Days</div><div class="s-val">${l7Cnt}</div></div>
      <div class="stat-card"><div class="s-label">7-Day Avg</div><div class="s-val">${(l7Cnt/7).toFixed(1)}</div></div>
      <div class="stat-card"><div class="s-label">Close Leads</div><div class="s-val blue">${proxCnt}</div></div>
      <div class="stat-card"><div class="s-label">% Close</div><div class="s-val blue">${proxPct}%</div></div>
    </div>
    ${cos.length?`
      <div class="section-label">Top Companies</div>
      ${cos.map(([cn,cnt])=>{
        const pct=(cnt/Math.max(1,cos[0][1])*100).toFixed(1);
        return `<div class="bar-row"><div class="bar-label" style="font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${cn}</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%">${cnt||""}</div></div></div>`;
      }).join("")}`:""}
    <div class="section-label" style="margin-top:16px">Recent Leads</div>
    ${ul.slice(0,12).map(e=>`
      <div class="feed-item">
        <div><span class="fi-co">${e.companyName||"‚Äî"}</span>${e.proximity?`<span class="fi-badge">CLOSE</span>`:""}</div>
        <div class="fi-time">${fmtTime(e.createdAt.toDate())}</div>
      </div>`).join("")||`<div class="empty">No leads yet.</div>`}`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ADMIN PANEL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
adminBtn.addEventListener("click",()=>{
  // reset to password screen
  adminPwScreen.style.display="";
  adminDash.style.display="none";
  adminPwInput.value="";
  adminPwError.classList.remove("show");
  adminModal.classList.add("open");
  setTimeout(()=>adminPwInput.focus(),100);
});
closeAdmin.addEventListener("click",()=>adminModal.classList.remove("open"));
adminModal.addEventListener("click",e=>{ if(e.target===adminModal) adminModal.classList.remove("open"); });

adminPwBtn.addEventListener("click",verifyAdminPw);
adminPwInput.addEventListener("keydown",e=>{ if(e.key==="Enter") verifyAdminPw(); });

async function verifyAdminPw(){
  // re-fetch in case it changed
  try{
    const snap=await getDoc(doc(db,"settings","global"));
    if(snap.exists()&&snap.data().password) ADMIN_PW=snap.data().password;
  }catch(e){}
  if(adminPwInput.value===ADMIN_PW){
    adminPwScreen.style.display="none";
    adminDash.style.display="";
    adminPwError.classList.remove("show");
    renderAdminCounts(allLeads);
  } else {
    adminPwError.classList.add("show");
    adminPwInput.value="";
    adminPwInput.focus();
  }
}

function renderAdminCounts(all){
  const container=document.getElementById("adminCountRows");
  if(!container||adminDash.style.display==="none") return;
  container.innerHTML=TEAM.map(n=>{
    const cnt=all.filter(e=>e.userName===n).length;
    return `<div class="admin-row">
      <span class="admin-label">${n}</span>
      <span style="font-size:13px;color:var(--muted);width:50px">(${cnt} now)</span>
      <input class="admin-input" id="count-input-${n}" type="number" min="0" max="99999" placeholder="New total" style="max-width:110px"/>
      <button class="admin-action-btn btn-yellow" onclick="window._setCount('${n}')">Set</button>
    </div>`;
  }).join("");
}

// exposed to onclick in HTML
window._setCount=async function(name){
  const input=document.getElementById("count-input-"+name);
  const target=parseInt(input?.value,10);
  if(isNaN(target)||target<0) return toast("Enter a valid number.",true);
  const current=allLeads.filter(e=>e.userName===name).length;
  const diff=target-current;
  if(diff===0) return toast("Already at that count.");

  try{
    if(diff>0){
      // add diff leads
      const CHUNK=499;
      for(let off=0;off<diff;off+=CHUNK){
        const batch=writeBatch(db);
        const chunk=Math.min(CHUNK,diff-off);
        for(let i=0;i<chunk;i++) batch.set(doc(collection(db,"leads")),{createdAt:serverTimestamp(),userName:name,companyId:"",companyName:"",proximity:false});
        await batch.commit();
      }
      toast(`Added ${diff} leads to ${name}.`);
    } else {
      // delete most recent |diff| leads for this user
      const toDel=allLeads.filter(e=>e.userName===name).slice(0,Math.abs(diff));
      const CHUNK=499;
      for(let off=0;off<toDel.length;off+=CHUNK){
        const batch=writeBatch(db);
        toDel.slice(off,off+CHUNK).forEach(e=>batch.delete(doc(db,"leads",e.id)));
        await batch.commit();
      }
      toast(`Removed ${Math.abs(diff)} leads from ${name}.`);
    }
    if(input) input.value="";
  }catch(e){ toast("Error updating count.",true); console.error(e); }
};

// Delete leads
const adminDeleteBtn=document.getElementById("adminDeleteBtn");
const adminDeleteConfirm=document.getElementById("adminDeleteConfirm");
const adminDeleteMsg=document.getElementById("adminDeleteMsg");
const adminDeleteConfirmBtn=document.getElementById("adminDeleteConfirmBtn");
const adminDeleteCancelBtn=document.getElementById("adminDeleteCancelBtn");
let pendingDeleteUser="";

adminDeleteBtn.addEventListener("click",()=>{
  const user=document.getElementById("adminDeleteUser").value;
  pendingDeleteUser=user;
  const cnt=user?allLeads.filter(e=>e.userName===user).length:allLeads.length;
  adminDeleteMsg.textContent=`Delete ${cnt} lead${cnt!==1?"s":""}${user?" for "+user:" (ALL analysts)"}? This cannot be undone.`;
  adminDeleteConfirm.classList.add("show");
});
adminDeleteCancelBtn.addEventListener("click",()=>{ adminDeleteConfirm.classList.remove("show"); pendingDeleteUser=""; });
adminDeleteConfirmBtn.addEventListener("click",async()=>{
  adminDeleteConfirm.classList.remove("show");
  const targets=pendingDeleteUser?allLeads.filter(e=>e.userName===pendingDeleteUser):allLeads;
  if(!targets.length) return toast("No leads to delete.");
  try{
    const CHUNK=499;
    for(let off=0;off<targets.length;off+=CHUNK){
      const batch=writeBatch(db);
      targets.slice(off,off+CHUNK).forEach(e=>batch.delete(doc(db,"leads",e.id)));
      await batch.commit();
    }
    toast(`Deleted ${targets.length} lead${targets.length!==1?"s":""}.`);
    pendingDeleteUser="";
  }catch(e){ toast("Error deleting leads.",true); console.error(e); }
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATS MODAL & TABS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
statsBtn.addEventListener("click",()=>statsModal.classList.add("open"));
closeStats.addEventListener("click",()=>statsModal.classList.remove("open"));
statsModal.addEventListener("click",e=>{ if(e.target===statsModal) statsModal.classList.remove("open"); });

tabBar.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    tabBar.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tab-panel").forEach(p=>p.classList.remove("active"));
    tab.classList.add("active");
    const p=document.getElementById("panel-"+tab.dataset.tab);
    if(p) p.classList.add("active");
  });
});
</script>
</body>
</html>
